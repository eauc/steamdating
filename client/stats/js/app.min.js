"use strict";angular.module("srApp.services",[]),angular.module("srAppStats.services",[]),angular.module("srApp.filters",[]),angular.module("srApp.controllers",[]),angular.module("srAppStats.controllers",[]),angular.module("srApp.directives",[]),angular.module("srAppStats",["ui.router","srAppStats.controllers","srApp.filters","srApp.services","srAppStats.services","srApp.directives"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/file"),a.state("file",{url:"/file",templateUrl:"partials/file.html",controller:"fileCtrl",data:{}}).state("stats",{url:"/stats",templateUrl:"/partials/stats.html",controller:"statsCtrl",data:{}})}]).config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob):/)}]),angular.module("srAppStats.controllers").controller("fileCtrl",["$scope","$q","prompt","fileImport",function(a,b,c,d){a.doReset=function(){c.prompt("confirm","You sure ?").then(function(){a.resetState()})},a.doOpenFile=function(b){_.each(b,function(b){d.read("json",b).then(function(c){var d=c[0],e=c[1];a.pushState({name:b.name,state:d}),a.open_result=e},function(b){a.open_result=b})})},a.doDropFile=function(b){a.dropState(b)}}]),angular.module("srAppStats.controllers").controller("mainCtrl",["$scope","$state","$window","jsonStringifier","factions",function(a,b,c,d,e){e.init(),a.goToState=_.bind(b.go,b),a.currentState=_.bind(_.getPath,_,b,"current.name"),a.stateIs=_.bind(b.is,b),a.resetState=function(){a.setState([])},a.setState=function(b){a.state=b,c.localStorage.setItem("srApp_stats",d.stringify(a.state))},a.pushState=function(b){a.setState(_.cat(a.state,[b]))},a.dropState=function(b){var c=_.clone(a.state);c.splice(b,1),a.setState(c)},a.state=[];var f=c.localStorage.getItem("srApp_stats");if(_.exists(f)&&!s.isBlank(f))try{a.setState(JSON.parse(f))}catch(g){a.state=[]}}]),angular.module("srAppStats.controllers").controller("statsCtrl",["$scope","$q","factions","players","stats",function(a,b,c,d,e){a.factions=_.chain(a.state).map(function(a){return d.factions(a.state.players)}).flatten().uniq().sortBy(_.identity).value(),a.players=_.chain(a.state).map(function(a){return d.names(a.state.players)}).flatten().uniq().sortBy(_.identity).value(),a.casters=_.chain(a.state).map(function(a){return d.casters(a.state.players)}).flatten(!0).uniq(function(a){return a.name}).apply(function(a){return a.sort(function(a,b){return a.faction!==b.faction?a.faction.localeCompare(b.faction):a.name.localeCompare(b.name)})}).value(),a.stats={};a.getStats=function(){var b=a.selection[a.selection.type],c=e.get(a.state,a.selection.type,b,a.selection.group_by,a.stats);return _.indexOf(_.mapWith(c,_.first),a.group)<0&&!_.isEmpty(c[0])&&(a.group=c[0][0]),c},a.selection={type:"faction",group_by:"total",faction:_.first(a.factions),player:_.first(a.players),caster:_.getPath(_.first(a.casters),"name")},a.setGroup=function(b){a.group=b}}]),angular.module("srAppStats.services").factory("stats",["statsFactionSelector","statsPlayerSelector","statsCasterSelector","statsGroupByTotal","statsGroupByOppFaction","statsGroupByOppCaster","statsPointsEntry","statsCastersEntry","statsOppCastersEntry","statsTiersEntry","statsReferencesEntry",function(a,b,c,d,e,f,g,h,i,j,k){function l(a,b){return{points:g.sum(a.points,b.points),casters:h.sum(a.casters,b.casters),opp_casters:i.sum(a.opp_casters,b.opp_casters),tiers:j.sum(a.tiers,b.tiers),references:k.sum(a.references,b.references)}}var m={faction:a,player:b,caster:c},n={total:d,opp_faction:e,opp_caster:f},o={get:function(a,b,c,d,e){return e[b]=e[b]||{},e[b][c]=e[b][c]||{},_.exists(e[b][c][d])||(e[b][c][d]=_.chain(a).map(function(a){var e=m[b].select(a.state,c);return e=n[d].group(a.state,e),_.map(e,function(b){return[b[0],{points:g.count(a.state,b[1]),casters:h.count(a.state,b[1]),opp_casters:i.count(a.state,b[1]),tiers:j.count(a.state,b[1]),references:k.count(a.state,b[1])}]})}).reduce(function(a,b){return _.addHeaderLists(a,b,l)},[]).value()),e[b][c][d]}};return o}]),_.mixin({addHeaderLists:function(a,b,c){return _.reduce(b,function(a,b){var d=_.find(a,function(a){return a[0]===b[0]});return _.exists(d)?(d[1]=c(d[1],b[1]),a):(a.push(_.snapshot(b)),a)},_.snapshot(a))}}),_.mixin({addObjects:function(a,b,c){return _.reduce(b,function(a,b,d){return a[d]=_.exists(a[d])?c(a[d],b):b,a},_.snapshot(a))}}),_.mixin({apply:function(a,b){var c=_.rest(_.rest(arguments));return b.apply(null,_.cons(a,c))}}),_.mixin({deepExtend:function(a){var b=/#{\s*?_\s*?}/,c=Array.prototype.slice;return _.each(c.call(arguments,1),function(c){for(var d in c)if(_.isUndefined(a[d])||_.isFunction(a[d])||_.isNull(c[d])||_.isDate(c[d]))a[d]=c[d];else if(_.isString(c[d])&&b.test(c[d]))_.isString(a[d])&&(a[d]=c[d].replace(b,a[d]));else if(_.isArray(a[d])||_.isArray(c[d])){if(!_.isArray(a[d])||!_.isArray(c[d]))throw new Error("Trying to combine an array with a non-array ("+d+")");a[d]=_.reject(_.deepExtend(_.clone(a[d]),c[d]),_.isNull)}else if(_.isObject(a[d])||_.isObject(c[d])){if(!_.isObject(a[d])||!_.isObject(c[d]))throw new Error("Trying to combine an object with a non-object ("+d+")");a[d]=_.deepExtend(_.clone(a[d]),c[d])}else a[d]=c[d]}),a}}),_.mixin({mapWith:function(a,b){var c=_.rest(_.rest(arguments)),d=_.partial.apply(null,_.cat([b,_],c));return _.map(a,d)},mapcatWith:function(a,b){var c=_.rest(_.rest(arguments)),d=_.partial.apply(null,_.cat([b,_],c));return _.mapcat(a,d)}}),_.mixin({spy:function(a){var b=_.rest(arguments);return console.log.apply(console,_.cat(b,[a])),a}}),_.mixin({toHeaderList:function(a){return _.map(a,function(a,b){return[b,a]})}}),angular.module("srApp.services").factory("backup",["$window","$q",function(a,b){return a.URL=a.URL||a.webkitURL,{read:function(c){var d=new a.FileReader,e=b.defer();return d.onload=function(a){var b;try{b=JSON.parse(a.target.result),e.resolve(b)}catch(c){e.reject("invalid file")}},d.onerror=function(){e.reject("error reading file")},d.onabort=function(){e.reject("abort reading file")},d.readAsText(c),e.promise},generate:function(b){return _.chain(b).apply(JSON.stringify).apply(function(b){return new a.Blob([b],{type:"text/plain"})}).apply(a.URL.createObjectURL).value()},cleanup:function(b){null!==b&&a.URL.revokeObjectURL(b)}}}]),angular.module("srApp.services").factory("bbStringifier",[function(){function a(a,b){return"["+b+"]"+a+"[/"+b+"]"}function b(a){return _.isArray(a)?a.join(e):a}function c(c,d){return _.chain(c).map(function(a){return _.exists(a)?a:""}).map(b).map(function(b){return 0===d?a(b,"b"):b}).mapWith(a,"center").mapWith(a,"td").join("").apply(a,"tr").value()}function d(b){var d=_.chain(b).rest().map(c).join(e).apply(a,"table").value();return _.cat([a(_.first(b).join(" "),"b")],d).join(e)}var e="\r\n",f={stringify:function(a){return _.chain(a).mapcat(d).join(e+e).value()}};return f}]),angular.module("srApp.services").factory("csvStringifier",[function(){function a(a){return _.isArray(a)?a.join(" "):a}function b(b){return _.map(b,a).join(",")}function c(a){return _.chain(a).map(b).join(d).value()}var d="\r\n",e={stringify:function(a){return _.chain(a).map(c).join(d+d).value()}};return e}]),angular.module("srApp.services").factory("factions",["$window","$http","$q",function(a,b,c){function d(){_.each(f,function(a){a.resolve(e)}),f=[]}var e,f=[];return{init:function(){b.get("/data/factions.json").then(function(a){e=a.data,d()},function(a){})},baseFactions:function(){if(_.exists(e))return e;var a=c.defer();return f.push(a),a.promise},iconFor:function(a){return _.chain([e]).mapWith(_.getPath,a+".icon").without(void 0,null).mapWith(function(a){return"data/icons/"+a}).first().value()},hueFor:function(a){return _.getPath(e,a+".hue")},castersFor:function(a){return _.getPath(e,a+".casters")},casterNameFor:function(a,b){return _.getPath(e,a+".casters."+b+".name")}}}]),angular.module("srApp.services").factory("jsonStringifier",[function(){var a={stringify:function(a){return JSON.stringify(a,function(a,b){return s.startsWith(a,"$$")?void 0:b})}};return a}]).factory("fileExport",["$window","fkStringifier","csvStringifier","bbStringifier","jsonStringifier",function(a,b,c,d,e){a.URL=a.URL||a.webkitURL;var f={fk:b,csv:c,bb:d,json:e};return{generate:function(b,c){return _.chain(c).apply(f[b].stringify).apply(function(b){return new a.Blob([b],{type:"text/plain"})}).apply(a.URL.createObjectURL).value()},cleanup:function(b){_.exists(b)&&a.URL.revokeObjectURL(b)}}}]),angular.module("srApp.services").factory("fileImport",["$window","$q","t3Parser","fkParser",function(a,b,c,d){var e={t3:c,fk:d,json:{parse:function(a){return[JSON.parse(a),[]]}}};return{read:function(c,d,f){var g=new a.FileReader,h=b.defer();return g.onload=function(a){var b;try{b=e[c].parse(a.target.result,f),h.resolve(b)}catch(d){h.reject(["invalid file : "+d.message])}},g.onerror=function(){h.reject(["error reading file"])},g.onabort=function(){h.reject(["abort reading file"])},g.readAsText(d),h.promise}}}]),angular.module("srApp.services").factory("fkParser",["player","list","lists",function(a,b,c){function d(a){return s.include(a,":")}function e(a,b,c){return b.line_number=c+1,d(a)?b.state.onParam(b,s(a).strLeft(":").trim().value(),s(a).strRight(":").trim().value(),s.trim(a)):s.isBlank(a)?b.state.onSeparator(b):b.state.onLine(b,s.trim(a))}function f(a,b){a.errors.push("line "+a.line_number+" "+b)}function g(a,b){return s.isBlank(b)?(f(a,"empty player name"),a.player=null,void(a.state=p)):(b=s.capitalize(b),0<=_.indexOf(a.players,b)?(f(a,'player name "'+b+'" already exists'),a.player=null,void(a.state=p)):(a.players.push(b),a.player={name:b},void(a.state=r)))}function h(a){return _.exists(a.player)?(a.list={content:[],faction:a.player.faction},void(a.state=t)):(f(a,"unexpected list definition"),void(a.state=p))}function i(a,b){var c=_.findKey(a.factions,function(a){return a.name===b});return _.exists(c)?void(a.player.faction=c):(f(a,'unknown faction "'+b+'"'),void(a.player.faction=b))}function j(a,b){a.player.origin=b}function k(a,b){var c=_.chain(a.factions).getPath(a.list.faction+".casters").findKey(function(a){return s.startsWith(b,a.name)}).value();if(!_.exists(c)){var d=b.match(/([a-zA-Z\s,]+)/);c=_.exists(d)?d[1]:"UNKNOWN",f(a,'unknown caster "'+b+'"')}a.list.caster=c,a.list.content.push(b),a.state=u}function l(b){b.result.push(a.create({name:b.player.name,faction:b.player.faction,origin:b.player.origin})),b.state=q}function m(a){var d=b.create({faction:a.list.faction,caster:a.list.caster,theme:a.list.theme,fk:a.list.content.join("\n")}),e=_.last(a.result);e.lists=c.add(e.lists,d),a.state=q}var n={parse:function(a,b){var c={factions:b,state:q,result:[],errors:[],players:[]};return _.chain(a).apply(s.lines).cat("").mapWith(e,c).value(),[c.result,c.errors]}},o={onParam:function(a,b,c){f(a,' parameter "'+b+'"="'+s.truncate(c,8)+'" ignored')},onSeparator:function(){},onLine:function(a,b){f(a,"ignored : "+s.truncate(b,15))}},p=_.defaults({onParam:function(){},onSeparator:function(a){a.state=q},onLine:function(){}},o),q=_.defaults({onParam:function(a,b,c){switch(b){case"Player":return void g(a,c);case"List":return void h(a);default:o.onParam(a,b,c)}}},o),r=_.defaults({onParam:function(a,b,c){switch(b){case"Faction":return void i(a,c);case"Origin":return void j(a,c);default:o.onParam(a,b,c)}},onSeparator:l},o),t=_.defaults({onParam:function(a,b,c,d){switch(b){case"Theme":return void(a.list.theme=c);default:s.endsWith(b,"WB")||s.endsWith(b,"WJ")?t.onLine(a,d):o.onParam(a,b,c)}},onSeparator:m,onLine:k},o),u=_.defaults({onSeparator:t.onSeparator,onParam:function(a,b,c,d){u.onLine(a,d)},onLine:function(a,b){a.list.content.push(b)}},o);return n}]),angular.module("srApp.services").factory("fkStringifier",[function(){function a(a){var d=["Player: "+a.name];return _.exists(a.origin)&&d.push("Origin: "+a.origin),_.exists(a.faction)&&d.push("Faction: "+a.faction),a.lists.length>0&&(d.push(""),d.push(_.map(a.lists,b).join(c))),d.join(c)+c}function b(a){var b=["List:"];return _.exists(a.theme)&&b.push("Theme: "+a.theme),b.push(a.fk),b.push(""),b.join(c)}var c="\r\n",d={stringify:function(b){return _.chain(b).flatten().map(a).join(c).value()}};return d}]),angular.module("srApp.services").factory("game",[function(){var a={create:function(a){return _.deepExtend({table:null,p1:{name:null,list:null,tournament:null,control:null,army:null,custom_field:null},p2:{name:null,list:null,tournament:null,control:null,army:null,custom_field:null},games:[]},a)},forPlayer:function(b,c){if(c===b.p1.name||c===b.p2.name)return b;if(0!==b.games.length)return _.chain(b.games).filter(_.partial(a.forPlayer,_,c)).first().value()},player:function(a,b){var c=_.getPath(a,"p1.name");return c===b?_.getPath(a,"p1"):_.getPath(a,"p2")},opponentForPlayer:function(a,b){var c=_.getPath(a,"p1.name");return c===b?_.getPath(a,"p2.name"):c},hasResult:function(a){return _.isNumber(a.p1.tournament)&&_.isNumber(a.p2.tournament)},winForPlayer:function(b,c){var d=_.chain(b).apply(a.player,c).getPath("tournament").value();return 1===d?!0:0===d?!1:void 0},listForPlayer:function(b,c){return _.chain(b).apply(a.player,c).getPath("list").value()},tableForPlayer:_.partial(_.getPath,_,"table"),isValid:function(a){return _.isString(a.p1.name)&&_.isString(a.p2.name)},winner:function(a){return 1===a.p1.tournament?a.p1.name:1===a.p2.tournament?a.p2.name:void 0},loser:function(b){return _.chain(b).apply(a.winner).apply(function(c){return _.exists(c)?a.opponentForPlayer(b,c):void 0}).value()},toArray:function(a,b){var c=[a.table,a.p1.name,a.p2.name,a.p1.list,a.p2.list,a.p1.tournament,a.p2.tournament,a.p1.control,a.p2.control,a.p1.army,a.p2.army];return b&&(c=_.cat(c,[a.p1.custom_field,a.p2.custom_field])),c}};return a}]).factory("games",["game",function(a){function b(a,b){return _.exists(b)&&a>=b}function c(a,c,d,e,f){var g=f>>d-e;return b(d,e)?a+g*c.tournament:a}var d={pointsForPlayer:function(b,c,e,f){return _.chain(b).mapWith(a.player,c).apply(d.reducePoints,e,f).value()},pointsAgainstPlayer:function(b,c,e,f){return _.chain(b).map(function(b){var d=a.opponentForPlayer(b,c);return a.player(b,d)}).apply(d.reducePoints,e,f).value()},reducePoints:function(a,b,d){return _.chain(a).reduce(function(a,e,f){return{bracket:c(a.bracket,e,f,b,d),tournament:a.tournament+(e.tournament||0),control:a.control+(e.control||0),army:a.army+(e.army||0),custom_field:a.custom_field+(e.custom_field||0),sos:0}},{bracket:0,tournament:0,control:0,army:0,custom_field:0,sos:0}).value()},opponentsForPlayer:function(b,c){return _.chain(b).mapWith(a.opponentForPlayer,c).without(void 0).value()},listsForPlayer:function(b,c){return _.chain(b).mapWith(a.listForPlayer,c).uniq().without(void 0,null).value()},tablesForPlayer:function(b,c){return _.chain(b).mapWith(a.tableForPlayer,c).without(void 0,null).value()},forCaster:function(b,c,d){return _.filter(b,function(b){return _.chain(b).apply(a.listForPlayer,c).value()===d})}};return d}]),angular.module("srApp.services").factory("list",[function(){return{create:function(a){return _.deepExtend({faction:null,caster:null,theme:null,fk:null},a)},references:function(a){return _.chain(a).getPath("fk").apply(s.lines).filter(_.complement(s.isBlank)).map(function(a){return a.replace(/\(.*\)/,"")}).map(function(a){return a.replace(/\[.*\]/,"")}).map(function(a){return a.replace(/- (PC|WJ|WB).*$/,"")}).map(function(a){return a.replace(/-[^-]*runt.*$/,"")}).map(function(a){return a.replace(/Objective/,"")}).map(function(a){return a.replace(/Specialists/,"")}).map(function(a){return a.replace(/UA/,"")}).map(function(a){return a.replace(/[^a-zA-Z\s&]/g,"")}).map(function(a){return s.trim(a)}).map(function(a){return s.titleize(a)}).filter(_.complement(s.isBlank)).value()}}}]).factory("lists",["list",function(){var a={add:function(a,b){return _.cat(a,b)},drop:function(a,b){var c=_.clone(a);return c.splice(b,1),c},casters:function(a){return _.mapWith(a,_.getPath,"caster")},listForCaster:function(a,b){return _.chain(a).where({caster:b}).first().value()},themeForCaster:function(b,c){return _.chain(b).apply(a.listForCaster,c).getPath("theme").value()},containsCaster:function(a,b){return _.chain(a).findWhere({caster:b}).exists().value()}};return a}]),angular.module("srApp.services").factory("basePairing",["rounds","players",function(a){var b={suggestTableFor:function(b,c,d,e){var f=a.tablesForPlayer(b,d),g=a.tablesForPlayer(b,e),h=_.difference(c,f,g);return 0===h.length?c[0]:h[0]}};return b}]).factory("bracketPairing",["basePairing","players","game","round","state",function(a,b,c,d,e){var f={indices:function(a){return 2===a?[[1,2]]:_.chain(f.indices(a/2)).map(function(b){return[[b[0],a+1-b[0]],[a+1-b[1],b[1]]]}).reduce(function(a,b){return _.cat(a,b)},[]).value()},suggestFirstSingleRound:function(d,e){var g=b.tableRangeForGroup(d.players,e),h=d.players[e],i=_.chain(h).apply(b.sortGroup,d,!1).mapcatWith(_.getPath,"players").value();return _.chain(i.length).apply(f.indices).map(function(b){var e=i[b[0]-1].name,f=i[b[1]-1].name,h=a.suggestTableFor(d.rounds,g,e,f);return g=_.without(g,h),c.create({table:h,p1:{name:e},p2:{name:f}})}).value()},suggestNextSingleRound:function(f,g){var h=b.tableRangeForGroup(f.players,g),i=e.bracketNbRounds(f,g);return _.chain(f.rounds).last().apply(d.gamesForGroup,f.players,g).chunk(f.players[g].length/(1<<i)).reduce(function(b,e){var g=d.winners(e),i=d.losers(e),j=_.chain(g).cat(i).chunk(2).value();return _.cat(b,_.map(j,function(b){var d=a.suggestTableFor(f.rounds,h,b[0],b[1]);return h=_.without(h,d),c.create({table:d,p1:{name:b[0]},p2:{name:b[1]}})}))},[]).value()},suggestFirstRound:function(a,b){return f.suggestFirstSingleRound(a,b)},suggestNextRound:function(a,b){return f.suggestNextSingleRound(a,b)},suggestRound:function(a,b){return 0===e.bracketNbRounds(a,b)?f.suggestFirstRound(a,b):f.suggestNextRound(a,b)}};return f}]).factory("srPairing",["basePairing","players","rounds","game",function(a,b,c,d){var e={sortPlayers:function(a){var b;return _.chain(a).groupBy(_.partial(_.getPath,_,"points.tournament")).tap(function(a){b=a}).keys().sortBy(function(a){return parseFloat(a)}).mapcat(function(a){return _.shuffle(b[a])}).reverse().value()},sortAvailablePlayersFor:function(a,b){var c;return _.chain(a).groupBy(_.partial(_.getPath,_,"points.tournament")).tap(function(a){c=a}).keys().sortBy(function(a){return"undefined"===a?-1:parseFloat(a)}).mapcat(function(a){var d=_.filter(c[a],function(a){return a.origin!==b.origin}),e=_.filter(c[a],function(a){return a.origin===b.origin});return _.cat(e,d)}).reverse().mapWith(_.partial(_.getPath,_,"name")).value()},suggestOpponentFor:function(a,b){var c=_.difference(b,a);return 0===c.length?b[0]:c[0]},findNextPairing:function(f,g,h){var i=_.first(g);g=_.rest(g);var j=c.opponentsForPlayer(f,i.name),k=e.sortAvailablePlayersFor(g,i),l=e.suggestOpponentFor(j,k),m=b.player(g,l);g=_.without(g,m);var n=a.suggestTableFor(f,h,i.name,m.name);return h=_.without(h,n),[d.create({table:n,p1:{name:i.name},p2:{name:m.name}}),g,h]},suggestNextSingleRound:function(a,c){var d=b.tableRangeForGroup(a.players,c),f=e.sortPlayers(a.players[c]);return 1===(1&f.length)&&f.push({name:"_phantom_"}),_.chain(a.players[c].length/2).range().map(function(){var b=e.findNextPairing(a.rounds,f,d);return f=b[1],d=b[2],b[0]}).sortBy(_.property("table")).value()},suggestNextRound:function(a,b){return e.suggestNextSingleRound(a,b)}};return e}]).factory("pairing",["bracketPairing","srPairing",function(a,b){var c={suggestRound:function(c,d,e){return _.exists(e)?a.suggestRound(c,d,e):b.suggestRound(c,d)}};return c}]),angular.module("srApp.services").factory("player",["rounds","list","lists",function(a,b,c){return{is:function(a,b){return a.name===b},rank:function(a,b){var c;try{c=b(a.custom_field,a.points.tournament,a.points.sos,a.points.control,a.points.army,a.points.custom_field)}catch(d){return"Error : "+d.message}return c},create:function(a){var c=_.deepExtend({name:null,faction:null,origin:null,team:null,custom_field:0,notes:null,lists:[],lists_played:[],points:{tournament:0,sos:0,control:0,army:0,custom_field:0}},a);return c.lists=_.map(c.lists,b.create),c},updateListsPlayed:function(b,c){return _.chain(b).clone().apply(function(b){return b.lists_played=a.listsForPlayer(c,b.name),b}).value()},allListsHaveBeenPlayed:function(a){return 0===_.chain(a.lists).apply(c.casters).difference(a.lists_played).value().length},updatePoints:function(b,c,d,e){return _.chain(b).clone().apply(function(b){return b.points=a.pointsForPlayer(c,b.name,d,e),b}).value()}}}]).factory("players",["player","factions","round","rounds","ranking","lists",function(a,b,c,d,e,f){function g(b,c,d){if(d)return function(a){return a.points.bracket};var f=e.buildPlayerCritFunction(c.ranking.player,c.rounds.length,b.length);return _.isFunction(f)?_.partial(a.rank,_,f):null}var h={add:function(a,b,c){return a[c]=_.cat(a[c],b),a},drop:function(b,c){return _.chain(b).mapWith(_.reject,_.partial(a.is,_,c.name)).reject(_.isEmpty).apply(function(a){return _.isEmpty(a)?[[]]:a}).value()},player:function(b,c){return _.chain(b).flatten(!0).find(_.partial(a.is,_,c)).value()},names:function(a){return _.chain(a).flatten(!0).mapWith(_.getPath,"name").sortBy(_.identity).value()},factions:function(a,b){return _.chain(a).flatten(!0).mapWith(_.getPath,"faction").cat(_.keys(b)).uniq().without(void 0).sortBy(_.identity).value()},forFaction:function(a,b){return _.chain(a).flatten(!0).filter(function(a){return _.getPath(a,"faction")===b}).value()},casters:function(a){return _.chain(a).flatten(!0).mapcatWith(_.getPath,"lists").without(void 0,null).map(function(a){return _.exists(a.caster)?{faction:a.faction||"",name:a.caster}:void 0}).without(void 0,null).uniq(!1,_.partial(_.getPath,_,"name")).apply(function(a){return a.sort(function(a,b){var c=a.faction.localeCompare(b.faction);return 0!==c?c:a.name.localeCompare(b.name)})}).value()},forCaster:function(a,b){return _.chain(a).flatten(!0).filter(function(a){return f.containsCaster(a.lists,b)}).value()},origins:function(a){return _.chain(a).flatten(!0).mapWith(_.getPath,"origin").uniq().without(void 0).sortBy(_.identity).value()},withPoints:function(a,b,c){return _.chain(a).flatten().filter(function(a){return 0!==_.getPath(a,b)&&_.getPath(a,b)===c}).pluck("name").value()},maxPoints:function(a,b){return _.chain(a).flatten().map(_.partial(_.getPath,_,b)).max().value()},bests:function(a,b){var c={custom_field:h.maxPoints(a,"custom_field"),points:{sos:h.maxPoints(a,"points.sos"),control:h.maxPoints(a,"points.control"),army:h.maxPoints(a,"points.army"),custom_field:h.maxPoints(a,"points.custom_field")}};return{undefeated:h.withPoints(a,"points.tournament",b),custom_field:h.withPoints(a,"custom_field",c.custom_field),points:{sos:h.withPoints(a,"points.sos",c.points.sos),control:h.withPoints(a,"points.control",c.points.control),army:h.withPoints(a,"points.army",c.points.army),custom_field:h.withPoints(a,"points.custom_field",c.points.custom_field)}}},updateListsPlayed:function(b,c){return _.chain(b).map(function(b){return _.mapWith(b,a.updateListsPlayed,c)}).value()},updatePoints:function(b,c,e,f){var g=_.chain(b).map(function(b,d){return _.mapWith(b,a.updatePoints,c,e[d],f[d])}).value();return _.chain(g).map(function(a){return _.map(a,function(a){var b=d.opponentsForPlayer(c,a.name);return a.points.sos=h.sosFromPlayers(g,b),a})}).value()},sortGroup:function(a,b,c){var d=g(a,b,c);if(!_.exists(d))return a;var e,f=0;return _.chain(a).groupBy(d).tap(function(a){e=a}).keys().sortBy(function(a){return-parseFloat(a)}).reduce(function(a,b){return a.push({rank:f+1,players:e[b]}),f+=e[b].length,a},[]).value()},sort:function(a,b,c){return _.map(a,function(a,d){return h.sortGroup(a,b,c[d])})},sosFromPlayers:function(a,b){return _.chain(b).map(_.partial(h.player,a)).without(void 0).reduce(function(a,b){return a+_.getPath(b,"points.tournament")},0).value()},areAllPaired:function(a,b){return _.chain(a).apply(h.names).difference(c.pairedPlayers(b)).isEmpty().value()},indexRangeForGroup:function(a,b){var c=_.chain(a).slice(0,b).flatten(!0).value().length,d=c+a[b].length;return[c,d]},chunkGroups:function(a,b){return _.chain(a).flatten(!0).chunkAll(b).value()},splitNewGroup:function(a,b){var c=_.map(b,_.partial(h.player,a));return _.chain(a).mapWith(_.difference,c).cat([c]).reject(_.isEmpty).value()},groupForPlayer:function(a,b){return _.chain(a).map(function(a){return _.findWhere(a,{name:b})}).findIndex(_.exists).value()},movePlayerGroupFront:function(a,b){var c=h.groupForPlayer(a,b);if(0>=c)return a;var d=h.player(a,b),e=_.clone(a);return e[c]=_.difference(a[c],[d]),e[c-1]=_.cat(a[c-1],d),_.reject(e,_.isEmpty)},movePlayerGroupBack:function(a,b){var c=h.groupForPlayer(a,b);if(0>c||c>=a.length-1)return a;var d=h.player(a,b),e=_.clone(a);return e[c]=_.difference(a[c],[d]),e[c+1]=_.cat(a[c+1],d),_.reject(e,_.isEmpty)},moveGroupFront:function(a,b){if(0>=b)return a;var c=_.clone(a);return c.splice(b,1),c.splice(b-1,0,a[b]),c},moveGroupBack:function(a,b){if(0>b||b>=a.length-1)return a;var c=_.clone(a);return c.splice(b,1),c.splice(b+1,0,a[b]),c},size:function(a){return _.flatten(a).length},nbGroups:function(a){return a.length},groupSizeIsEven:function(a){return 0===(1&a.length)},tableRangeForGroup:function(a,b){var c=h.indexRangeForGroup(a,b);return _.range(Math.round(c[0]/2+1),Math.round(c[1]/2+1))}};return h}]),angular.module("srApp.services").factory("ranking",[function(){var a={srPlayerCrit:function(){return"((tp*n_players*n_players+sos)*5*n_rounds+cp)*100*n_rounds+ap"},srTeamCrit:function(){return"(((ttp*team_size*n_rounds+tp)*n_teams*n_teams+sos)*5*n_rounds+cp)*100*n_rounds+ap"},buildPlayerCritFunction:function(a,b,c){var d,e;try{d=new Function("n_rounds","n_players","player_custom","tp","sos","cp","ap","game_custom","return "+a+";"),e=_.partial(d,b,c)}catch(f){return"Error : "+f.message}return e}};return a}]),angular.module("srApp.services").factory("round",["game",function(a){var b={gameForPlayer:function(b,c){return _.isArray(b)&&0!==b.length?_.chain(b).map(_.partial(a.forPlayer,_,c)).without(void 0).first().value():void 0},gamesForGroup:function(a,b,c){var d=Math.ceil(_.chain(b).slice(0,c).flatten().value().length/2),e=Math.ceil(d+b[c].length/2);return _.chain(a).slice(d,e).value()},pairedPlayers:function(a){return _.chain(a).flatten().mapcat(function(a){return[a.p1.name,a.p2.name]}).uniq().without(null,void 0).value()},isPlayerPaired:function(a,c){return 0<=_.chain(a).apply(b.pairedPlayers).indexOf(c.name).value()},updatePlayer:function(a,b,c){var d=a[b][c].name;return _.chain(a).map(function(a,e){if(e===b&&"p1"===c)return a;if(a.p1.name===d){var f=_.snapshot(a);return f.p1.name=null,f}return a}).map(function(a,e){if(e===b&&"p2"===c)return a;if(a.p2.name===d){var f=_.snapshot(a);return f.p2.name=null,f}return a}).value()},updateTable:function(a,b,c){var d=a[b].table,e=d-c;return a[e]=_.snapshot(a[e]),a[e].table=c+b,_.chain(a).sortBy("table").value()},allGamesHaveResult:function(b){return _.chain(b).map(a.hasResult).spy("hasres").all().spy("all").value()},winners:function(b){return _.map(b,a.winner)},losers:function(b){return _.map(b,a.loser)}};return b}]).factory("rounds",["round","game","games",function(a,b,c){var d={lastRoundIsComplete:function(b){return _.isEmpty(b)||_.chain(b).last().apply(a.allGamesHaveResult).value()},createNextRound:function(a){var c=1;return _.map(a,function(a){return _.chain(a.length/2).range().map(function(){return b.create({table:c++})}).value()})},registerNextRound:function(a,b){return _.cat(a,[_.flatten(b)])},drop:function(a,b){var c=_.clone(a);return c.splice(b,1),c},pointsForPlayer:function(b,d,e,f){return _.chain(b).mapWith(a.gameForPlayer,d).map(function(a){return _.exists(a)?a:{p1:{name:d,tournament:0,control:0,army:0,custom_field:0}}}).apply(c.pointsForPlayer,d,e,f).value()},gamesForPlayer:function(b,c){return _.chain(b).mapWith(a.gameForPlayer,c).without(void 0).value()},opponentsForPlayer:function(b,d){return _.chain(b).mapWith(a.gameForPlayer,d).without(void 0).apply(c.opponentsForPlayer,d).value()},pairAlreadyExists:function(a,b){return _.exists(_.getPath(b,"p1.name"))&&_.exists(_.getPath(b,"p2.name"))?_.chain(a).apply(d.opponentsForPlayer,b.p1.name).indexOf(b.p2.name).value()>=0:!1},listsForPlayer:function(b,d){return _.chain(b).mapWith(a.gameForPlayer,d).apply(c.listsForPlayer,d).value()},tablesForPlayer:function(b,d){return _.chain(b).mapWith(a.gameForPlayer,d).apply(c.tablesForPlayer,d).value()}};return d}]),angular.module("srApp.services").factory("state",["$window","jsonStringifier","player","players","game","list","lists","ranking","round",function(a,b,c,d,e,f,g,h,i){function j(a){return _.chain(a).apply(v.sortPlayersByRank).first().map(function(a){return _.map(a.players,function(b){return[b.faction,b.name,a.rank]})}).flatten(!0).uniq(!1,_.first).reduce(function(a,b){return a[_.first(b)]=_.rest(b),a},{}).value()}function k(a){var b=m(a),c=n(a);return[["Bests"],b,c]}function l(a){var b=_.chain(a).getPath("bests_in_faction").pairs().map(function(a){return _.cat(a[0],a[1])}).sortBy(_.partial(_.nth,_,2)).value();return[_.cat([["Bests In Faction"],["Faction","Player","Rank"]],b)]}function m(a){var b=v.hasPlayerCustomField(a),c=v.hasGameCustomField(a),d=["Undefeated"];return b&&d.push(a.custom_fields.player),d=_.cat(d,["SoS","Scenario","Destruction"]),c&&d.push(a.custom_fields.game),d}function n(a){var b=v.hasPlayerCustomField(a),c=v.hasGameCustomField(a),d=[_.getPath(a,"bests.undefeated")];return b&&d.push(_.getPath(a,"bests.custom_field")),d=_.cat(d,[_.getPath(a,"bests.points.sos"),_.getPath(a,"bests.points.control"),_.getPath(a,"bests.points.army")]),c&&d.push(_.getPath(a,"bests.points.custom_field")),d}function o(a){v.hasPlayerCustomField(a),v.hasGameCustomField(a);return _.chain(a).apply(v.sortPlayersByRank).map(_.partial(r,_,a)).map(_.partial(p,_,_,a)).value()}function p(a,b,c){var d=q(c);return _.cat([["Group"+(b+1)],d],a)}function q(a){var b=v.hasPlayerCustomField(a),c=v.hasGameCustomField(a),d=["Rank","Name","Origin","Faction"];return b&&(d=_.cat(d,[a.custom_fields.player])),d=_.cat(d,["TP","SoS","CP","AP"]),c&&(d=_.cat(d,[a.custom_fields.game])),d}function r(a,b){var c=v.hasPlayerCustomField(b),d=v.hasGameCustomField(b);return _.chain(a).map(function(a){var c=_.partial(t,_,a.rank,b);return _.map(a.players,c)}).flatten().chunk(8+(c?1:0)+(d?1:0)).value()}function t(a,b,c){var d=v.hasPlayerCustomField(c),e=v.hasGameCustomField(c),f=[b,a.name,a.origin,a.faction];return d&&(f=_.cat(f,[a.custom_field])),f=_.cat(f,[a.points.tournament,a.points.sos,a.points.control,a.points.army]),e&&(f=_.cat(f,[a.points.custom_field])),f}var u="sdApp.state",v={isEmpty:function(a){return 0===_.flatten(a.players).length&&0===_.flatten(a.rounds).length},init:function(){var b=a.localStorage.getItem(u);if(_.exists(b))try{return b=JSON.parse(b),v.create(b)}catch(c){}return v.create()},test:function(a){var b=_.clone(a),h=["Faction1","Faction2","Faction3","Faction4"],i=["City1","City2","City3","City4"],j=["Team1","Team2","Team3","Team4"];return b.players=[[],[]],_.range(8).map(function(a){var d=_.chain(h).shuffle().first().value();b.players[a>>2].push(c.create({name:"Player"+(a+1),faction:d,origin:_.chain(i).shuffle().first().value(),team:_.chain(j).shuffle().first().value()})),b.players[a>>2][a%4].lists.push(f.create({faction:d,caster:"Caster1"}),f.create({faction:d,caster:"Caster2"})),b.players[a>>2][a%4].custom_field=50*Math.random()>>0}),_.range(2).map(function(a){b.rounds.push([]);var c=1;_.each(b.players,function(f){var h=_.shuffle(d.names(f));_.range(h.length/2).map(function(){var f=_.first(h);h=_.rest(h);var i=_.first(h);h=_.rest(h);var j=e.create({table:c++,p1:{name:f},p2:{name:i}});j.p1.list=_.chain(b.players).apply(d.player,f).getPath("lists").apply(g.casters).shuffle().first().value(),j.p2.list=_.chain(b.players).apply(d.player,i).getPath("lists").apply(g.casters).shuffle().first().value();var k=_.shuffle(["p1","p2"]);j[k[0]].tournament=1,j[k[1]].tournament=0,j.p1.control=5*Math.random()>>0,j.p2.control=5*Math.random()>>0,j.p1.army=50*Math.random()>>0,j.p2.army=50*Math.random()>>0,j.p1.custom_field=50*Math.random()>>0,j.p2.custom_field=50*Math.random()>>0,b.rounds[a].push(j)
})})}),b.bracket=[void 0,1],b.custom_fields.player="PCustom",b.custom_fields.game="GCustom",b=v.updatePlayersPoints(b)},create:function(a){var b=_.deepExtend({bracket:[],players:[[]],rounds:[],ranking:{player:h.srPlayerCrit(),team:h.srTeamCrit()},custom_fields:{player:null,game:null}},a);return b.players=_.map(b.players,function(a){return _.map(a,c.create)}),b.rounds=_.map(b.rounds,function(a){return _.map(a,e.create)}),b=v.updatePlayersPoints(b),v.store(b),b},store:function(c){a.localStorage.setItem(u,b.stringify(c))},hasPlayers:function(a){return 0!==_.flatten(a.players).length},hasPlayerGroups:function(a){return a.players.length>1},isTeamTournament:function(a){return 0!==_.flatten(a.teams).length},hasPlayerCustomField:function(a){return!s.isBlank(a.custom_fields.player)},hasGameCustomField:function(a){return!s.isBlank(a.custom_fields.game)},clearBracket:function(a){return _.repeat(a.players.length,void 0)},setBracketLength:function(a,b){return a.bracket.length>=b?_.clone(a.bracket):_.cat(a.bracket,_.repeat(b-a.bracket.length,void 0))},setBracket:function(a,b){var c=v.setBracketLength(a,b+1);return c[b]=_.exists(c[b])?c[b]:a.rounds.length,c},resetBracket:function(a,b){var c=v.setBracketLength(a,b+1);return c[b]=void 0,c},canBeBracketTournament:function(a,b){var c=a.players[b].length;if(0===c)return!1;for(;0===(1&c);)c>>=1;return 1===c},isBracketTournament:function(a,b,c){c=_.exists(c)?c:a.rounds.length;v.setBracketLength(a,b+1);return _.exists(a.bracket[b])&&c>=a.bracket[b]},bracketNbRounds:function(a,b){var c=v.setBracketLength(a,b+1);return _.exists(c[b])?a.rounds.length-c[b]:0},bracketRoundOf:function(a,b,c){if(!_.exists(a.bracket[b]))return"Not in bracket";c=_.exists(c)?c:a.rounds.length;var d=a.players[b].length>>c-a.bracket[b]+1;switch(d){case 0:return"Ended";case 1:return"Final";case 2:return"Semi-finals";case 4:return"Quarter-finals";default:return"Round of "+d}},updatePlayersPoints:function(a){var b=_.clone(a),c=v.setBracketLength(b,b.players.length),e=_.map(b.players,function(a){return a.length/2});return b.players=d.updatePoints(b.players,b.rounds,c,e),b},updateBestsPlayers:function(a){var b=_.clone(a);return b.bests=d.bests(a.players,_.size(a.rounds)),b.bests_in_faction=j(b),b},isPlayerBest:function(a,b,c){return 0<=_.indexOf(_.getPath(a.bests,b),_.getPath(c,"name"))},isPlayerBestInFaction:function(a,b){return b.name===_.chain(a).getPath("bests_in_faction."+b.faction).first().value()},sortPlayersByName:function(a){return _.map(a.players,function(a){return _.sortBy(a,"name")})},sortPlayersByRank:function(a){var b=_.map(a.players,function(b,c){return v.isBracketTournament(a,c)});return d.sort(a.players,a,b)},rankingTables:function(a){var b=k(a),c=l(a),d=o(a),e=_.cat([b],c,d);return e},roundTables:function(a,b){var c=v.hasGameCustomField(a),d=a.rounds[b];return _.chain(a.players).map(function(b,c){return i.gamesForGroup(d,a.players,c)}).map(function(a){return _.mapWith(a,e.toArray,c)}).map(function(b){var d=["Table","Player1","Player2","Player1.list","Player2.list","Player1.tp","Player2.tp","Player1.cp","Player2.cp","Player1.ap","Player2.ap"];return c&&(d=_.cat(d,["Player1."+a.custom_fields.game,"Player2."+a.custom_fields.game])),_.cat([d],b)}).value()}};return v}]),angular.module("srApp.services").factory("statsPointsEntry",["games",function(a){function b(a){return a[0]}function c(a){return a[1]}function d(a){return a[0]}function e(a){return a[1]}function f(a){return a[2]}var g={count:function(g,h){return{colors:["#4AE34D","#E3341D"],values:_.chain(h).mapWith(function(d){return[a.pointsForPlayer(c(d),b(d)),a.pointsAgainstPlayer(c(d),b(d)),c(d).length]}).reduce(function(a,b){return[{tournament:d(a).tournament+d(b).tournament,control:d(a).control+d(b).control,army:d(a).army+d(b).army},{tournament:e(a).tournament+e(b).tournament,control:e(a).control+e(b).control,army:e(a).army+e(b).army},f(b)+f(a)]},[{tournament:0,control:0,army:0},{tournament:0,control:0,army:0},0]).apply(function(a){var b=0===f(a)?1:f(a);return{"Win/Loss":[d(a).tournament,e(a).tournament],Control:[d(a).control/b,e(a).control/b],Army:[d(a).army/b,e(a).army/b]}}).value()}},sum:function(a,b){var c=_.clone(a);return c.values={"Win/Loss":[a.values["Win/Loss"][0]+b.values["Win/Loss"][0],a.values["Win/Loss"][1]+b.values["Win/Loss"][1]],Control:[(a.values.Control[0]+b.values.Control[0])/2,(a.values.Control[1]+b.values.Control[1])/2],Army:[(a.values.Army[0]+b.values.Army[0])/2,(a.values.Army[1]+b.values.Army[1])/2]},c}};return g}]).factory("statsCastersEntry",["factions","game","players",function(a,b,c){function d(a){return a[0]}function e(a){return a[1]}function f(a){return a[0]}function g(a){return a[1]}var h={count:function(h,i){return _.chain(i).map(function(a){return _.map(e(a),function(c){return[d(a),b.listForPlayer(c,d(a))]})}).flatten(!0).filter(function(a){return _.exists(f(a))&&_.exists(g(a))}).groupBy(function(a){return _.chain(h.players).apply(c.player,f(a)).getPath("faction").value()}).map(function(b,c){var d=_.map(b,g);return[c,_.countBy(d,_.identity),a.hueFor(c)]}).value()},sum:function(a,b){return _.addHeaderLists(a,b,_.partial(_.addObjects,_,_,_.add))}};return h}]).factory("statsOppCastersEntry",["factions","game","players",function(a,b,c){function d(a){return a[0]}function e(a){return a[1]}function f(a){return a[0]}function g(a){return a[1]}var h={count:function(h,i){return _.chain(i).map(function(a){return _.map(e(a),function(c){var e=b.opponentForPlayer(c,d(a));return[e,b.listForPlayer(c,e)]})}).flatten(!0).filter(function(a){return _.exists(f(a))&&_.exists(g(a))}).groupBy(function(a){return _.chain(h.players).apply(c.player,f(a)).getPath("faction").value()}).map(function(b,c){var d=_.map(b,g);return[c,_.countBy(d,_.identity),a.hueFor(c)]}).value()},sum:function(a,b){return _.addHeaderLists(a,b,_.partial(_.addObjects,_,_,_.add))}};return h}]).factory("statsTiersEntry",["list","lists","players","game",function(a,b,c,d){function e(a){return a[0]}function f(a){return a[1]}function g(a){return a[0]}function h(a){return a[1]}var i={count:function(a,i){return _.chain(i).map(function(b){return[c.player(a.players,e(b)),_.chain(f(b)).mapWith(d.listForPlayer,e(b)).without(void 0,null).value()]}).filter(function(a){return _.exists(g(a))}).mapcat(function(a){return _.map(h(a),function(c){return b.themeForCaster(g(a).lists,c)||"None"})}).without(null,void 0).countBy(_.identity).value()},sum:function(a,b){return _.addObjects(a,b,_.add)}};return i}]).factory("statsReferencesEntry",["list","lists","players","game",function(a,b,c,d){function e(a){return a[0]}function f(a){return a[1]}function g(a){return a[0]}function h(a){return a[1]}var i={count:function(i,j){return _.chain(j).map(function(a){return[c.player(i.players,e(a)),_.chain(f(a)).mapWith(d.listForPlayer,e(a)).without(void 0,null).uniq().value()]}).mapcat(function(a){return _.map(h(a),function(c){return b.listForCaster(g(a).lists,c)})}).without(void 0,null).mapWith(a.references).mapcatWith(_.rest).countBy(_.identity).value()},sum:function(a,b){return _.addObjects(a,b,_.add)}};return i}]),angular.module("srApp.services").factory("statsGroupByTotal",[function(){var a={group:function(a,b){return[["Total",b]]}};return a}]).factory("statsGroupByOppFaction",["game","players",function(a,b){function c(a){return a[0]}function d(a){return a[1]}var e={group:function(e,f){return _.chain(f).map(function(f){return[c(f),_.groupBy(d(f),function(d){var g=a.opponentForPlayer(d,c(f)),h=b.player(e.players,g);return s.capitalize(_.getPath(h,"faction")||"NULL")})]}).omit("NULL").reduce(function(a,b){return _.each(d(b),function(d,e){a[e]=a[e]||[],a[e].push([c(b),d])}),a},{}).toHeaderList().sortBy(_.first).value()}};return e}]).factory("statsGroupByOppCaster",["game","players",function(a){function b(a){return a[0]}function c(a){return a[1]}var d={group:function(d,e){return _.chain(e).map(function(d){return[b(d),_.groupBy(c(d),function(c){var e=a.opponentForPlayer(c,b(d)),f=a.player(c,e);return s.capitalize(_.getPath(f,"list")||"NULL")})]}).omit("NULL").reduce(function(a,d){return _.each(c(d),function(c,e){a[e]=a[e]||[],a[e].push([b(d),c])}),a},{}).toHeaderList().sortBy(_.first).value()}};return d}]),angular.module("srApp.services").factory("statsFactionSelector",["players","rounds",function(a,b){var c={select:function(c,d){var e=a.forFaction(c.players,d);return _.chain(e).mapWith(function(a){return[a.name,b.gamesForPlayer(c.rounds,a.name)]}).value()}};return c}]).factory("statsPlayerSelector",["players","rounds",function(a,b){var c={select:function(a,c){return[[c,b.gamesForPlayer(a.rounds,c)]]}};return c}]).factory("statsCasterSelector",["players","rounds","games",function(a,b,c){function d(a){return a[0]}function e(a){return a[1]}var f={select:function(f,g){var h=a.forCaster(f.players,g);return _.chain(h).map(function(a){return[a.name,b.gamesForPlayer(f.rounds,a.name)]}).map(function(a){return[d(a),c.forCaster(e(a),d(a),g)]}).filter(function(a){return!_.isEmpty(e(a))}).value()}};return f}]),angular.module("srApp.services").factory("t3Parser",["player",function(a){function b(a,b){var c=10===a.length;return c||e(b,"invalid fields number ("+a.length+" expected 10)"),c}function c(a,b){var c=s.trim(a[3]).length>0;return c||e(b,"empty player name"),c}function d(a,b){var c=0>_.indexOf(b.names,s.trim(a[3]));return c?b.names.push(s.trim(a[3])):e(b,'player name "'+s.trim(a[3])+'" already exists'),c}function e(a,b){a.errors.push("line "+a.line_number+" "+b)}var f={parse:function(b,c){var d=_.reduce(c,function(a,b){return a[b.t3]=b.name,a},{}),e={errors:[],names:[]},f=_.chain(b).apply(s.lines).rest().filter(_.complement(s.isBlank)).mapWith(s.words,";").filter(function(a,b){e.line_number=b+2;var c=_.map(g,function(b){return b(a,e)});return _.all(c)}).map(function(a){var b={name:s.capitalize(s.trim(a[3])),origin:a[5]};return _.each(d,function(c,d){s.include(a[4],d)&&(b.faction=c)}),b}).map(function(b){return a.create({name:b.name,faction:b.faction,origin:b.origin})}).value();return[f,e.errors]}},g=[b,c,d];return f}]),angular.module("srApp.directives").factory("appCache",["$window","$rootScope",function(a){function b(a){var b="progress"===a.type;c.progress=b?(c.progress+1)%100:0,c.onProgress(b)}var c={progress:0,onProgress:function(){},onUpdateReady:function(){}},d=a.applicationCache;return d.addEventListener("cached",b,!1),d.addEventListener("checking",b,!1),d.addEventListener("downloading",b,!1),d.addEventListener("error",b,!1),d.addEventListener("noupdate",b,!1),d.addEventListener("obsolete",b,!1),d.addEventListener("progress",b,!1),d.addEventListener("updateready",function(a){d.status===d.UPDATEREADY&&c.onUpdateReady(),c.progress=0,c.onProgress(!1)},!1),c}]).directive("appCacheProgressBar",function(){return{restrict:"E",template:'<div class="appcache-progress"     ng-show="appCache.progress != 0">  <div class="appcache-progress-bar"       ng-style="{\'width\': appCache.progress + \'%\' }"></div></div>',controller:["$scope","$window","prompt","appCache",function(a,b,c,d){a.appCache=d,d.onProgress=function(){a.$digest()},d.onUpdateReady=function(){c.prompt("confirm","A new version of this site is available. Load it?").then(function(){b.location.reload()})}}],link:function(){}}}),angular.module("srApp.directives").directive("autofocus",function(){return{restrict:"A",link:function(a,b){b[0].focus()}}}),angular.module("srApp.directives").controller("barsCtrl",["$scope",function(a){a.$watch("values",function(b){if(!_.exists(b))return void(a.bars=[]);var c=Math.max.apply(null,_.values(b)),d=30/Math.max(1,_.keys(b).length-1);a.bars=_.chain(b).map(function(b,d){return{k:d,name:s.capitalize(d),width:a.width*b/c,value:b}}).apply(function(a){return a.sort(function(a,b){return a.value<b.value?1:b.value<a.value?-1:a.name.localeCompare(b.name)})}).map(function(b,c){return b.color=_.exists(_.getPath(a.hues,b.k))?"hsl("+_.getPath(a.hues,b.k)[0]+", "+_.getPath(a.hues,b.k)[1]+"%, 52%)":"hsl("+a.hue+", "+a.saturation+"%, "+(35+c*d)+"%)",b}).value()})}]).directive("bars",[function(){return{restrict:"E",templateUrl:"/partials/directives/bars.html",scope:{values:"=barsValues",hues:"=barsHues"},controller:"barsCtrl",link:function(a,b,c){a.width=.7*(b[0].querySelector("table").offsetWidth>>0),a.height=50,a.hue="200",c.$observe("barsHue",function(b){a.hue=_.exists(b)?b:"200"}),a.saturation="75",c.$observe("barsSaturation",function(b){a.saturation=_.exists(b)?b:"75"})}}}]),angular.module("srApp.directives").directive("closeAllDropdown",[function(){return{restrict:"A",link:function(a,b){b.on("click",function(){a.$broadcast("close-dropdown")})}}}]).directive("openDropdown",[function(){return{restrict:"A",link:function(a,b,c){var d=c.openDropdown,e=angular.element(document.getElementById(d));_.exists(e)&&(b.on("click",function(a){e.toggleClass("open"),a.stopPropagation()}),a.$on("close-dropdown",function(){e.removeClass("open")}))}}}]),angular.module("srApp.directives").directive("eaFile",function(){return{restrict:"A",scope:{eaFile:"&"},controller:["$scope",function(){}],link:function(a,b){b[0].onchange=function(){var c=b[0].files;a.eaFile({file:c})}}}}),angular.module("srApp.directives").factory("prompt",["$q",function(a){function b(){if(_.exists(c))return c;var b=a.defer();return e.push(b),b.promise}var c,d,e=[];return{register:function(a){c=a,c.active=!1,c.message=null,c.type="alert",c.input=null,c.doValidate=function(){c.close(),d.resolve(c.input),d=null},c.doCancel=function(){c.close(),d.reject(),d=null},_.each(e,function(a){a.resolve(c)}),e=[]},prompt:function(c,e){return d=a.defer(),a.when(b()).then(function(a){a.type=c,a.message=_.isString(e)?[e]:e,a.input=null,a.open()}),d.promise}}}]).controller("promptCtrl",["$scope","prompt",function(a,b){b.register(a)}]).directive("prompt",["$timeout",function(a){return{restrict:"E",templateUrl:"/partials/directives/prompt.html",scope:!0,controller:"promptCtrl",link:function(b,c){var d=c[0].querySelector("input");b.open=function(){b.active=!0,a(function(){d.focus()},200)},b.close=function(){b.active=!1}}}}]),angular.module("srApp.directives").controller("stacksCtrl",["$scope",function(a){a.$watch("values",function(b){if(!_.exists(b))return void(a.stacks=[]);var c=_.reduce(b.values,function(a,b,c){return a[c]=_.reduce(b,function(a,b){return a+b},0),a},{});a.stacks=_.map(b.values,function(d,e){var f=0;return{name:e,layers:_.map(d,function(g,h){var i=0<c[e]?a.width*g/c[e]:a.width/d.length,j={x:f,width:i,color:b.colors[h],value:s.numberFormat(g,2)};return f+=i,j})}})})}]).directive("stacks",[function(){return{restrict:"E",templateUrl:"/partials/directives/stacks.html",scope:{values:"=stacksValues"},controller:"stacksCtrl",link:function(a,b){a.width=.7*(b[0].querySelector("table").offsetWidth>>0),a.height=50}}}]);