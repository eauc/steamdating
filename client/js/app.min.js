"use strict";angular.module("srApp.services",[]),angular.module("srApp.filters",[]),angular.module("srApp.controllers",[]),angular.module("srApp",["ui.router","srApp.controllers","srApp.filters","srApp.services"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/players"),a.state("players",{url:"/players",templateUrl:"partials/players.html",controller:"playersCtrl",data:{}}).state("players_add",{url:"/players_add",templateUrl:"partials/players_add.html",controller:"playersAddCtrl",data:{}}).state("rounds",{url:"/rounds/:pane",templateUrl:"partials/rounds.html",controller:"roundsCtrl",data:{}}).state("game_edit",{templateUrl:"partials/game_edit.html",controller:"gameEditCtrl",data:{}})}]).config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob):/)}]),angular.module("srApp.controllers").controller("gameEditCtrl",["$scope","$stateParams","rounds","players",function(a,b,c,d){a.game=_.snapshot(a.edit.game),a.setWinLoss=function(b,c){a.game[b].tournament=1,a.game[c].tournament=0},a.close=function(b){if(b){_.extend(a.edit.game,a.game);var e=d.player(a.state.players,a.game.p1.name);e.points=c.pointsFor(a.state.rounds,a.game.p1.name);var f=d.player(a.state.players,a.game.p2.name);f.points=c.pointsFor(a.state.rounds,a.game.p2.name);var g=_.chain([]).cat(c.opponentsFor(a.state.rounds,e.name)).cat(c.opponentsFor(a.state.rounds,f.name)).uniq().value();_.each(g,function(b){var e=d.player(a.state.players,b);e.points.sos=d.sosFrom(a.state.players,c.opponentsFor(a.state.rounds,e.name))})}a.goToState("rounds",{pane:a.edit.rounds_pane})}}]),angular.module("srApp.controllers").controller("mainCtrl",["$scope","$state","player","players","rounds",function(a,b,c,d,e){a.edit={},a.state={phantom:c.create("Phantom"),players:[],rounds:[]},a.goToState=_.bind(b.go,b),a.currentState=_.bind(_.getPath,_,b,"current.name"),a.state.rounds=_.range(4).map(function(a){return _.range(4).map(function(b){var c={table:(a+b)%4+1,p1:{name:"Player"+(2*b+1),tournament:a/2>>0,control:5*Math.random()>>1,army:50*Math.random()>>1},p2:{name:"Player"+((2*b+2*a)%8+2),tournament:1-(a/2>>0),control:5*Math.random()>>1,army:50*Math.random()>>1}};return c.p2.name="Player8"===c.p2.name?"Phantom":c.p2.name,c})}),a.state.players=_.range(7).map(function(b){return{name:"Player"+(b+1),faction:"Faction"+((b/2>>0)+1),city:"City"+((b/3>>0)+1),points:e.pointsFor(a.state.rounds,"Player"+(b+1))}}),a.state.players.push(a.state.phantom),a.state.phantom.points=e.pointsFor(a.state.rounds,"Phantom"),_.each(a.state.players,function(b){b.points.sos=d.sosFrom(a.state.players,e.opponentsFor(a.state.rounds,b.name))})}]),angular.module("srApp.controllers").controller("playersCtrl",["$scope","$state",function(a,b){}]).controller("playersAddCtrl",["$scope","players","player",function(a,b,c){function d(){a.name="Player",a.faction="",a.city=""}d(),a.doAddPlayer=function(){a.state.players=b.add(a.state.players,c.create(a.name,a.faction,a.city),a.state.phantom),a.goToState("players")}}]),angular.module("srApp.controllers").controller("roundsCtrl",["$scope","rounds","players","$stateParams",function(a,b,c,d){function e(c){a[c]=function(d,e){return b.query(a.state.rounds,e,d,c)}}return a.pane=d.pane,a.pane>=a.state.rounds.length?void a.goToState("rounds",{pane:"sum"}):(a.roundsRange=function(){return _.range(a.state.rounds.length)},e("opponentFor"),e("successFor"),e("tableFor"),a.round=function(c){return b.round(c)(a.state.rounds)},a.next_round=_.range(a.state.players.length/2).map(function(a){return{table:a+1,p1:{name:null,tournament:null,control:null,army:null},p2:{name:null,tournament:null,control:null,army:null}}}),a.playerNames=function(){return c.names(a.state.players)},a.suggestNextRound=function(){var d=c.names(c.sort(a.state.players));a.next_round=b.suggestNextRound(a.state.rounds,d)},a.registerNextRound=function(){a.state.rounds.push(a.next_round),a.goToState("rounds",{pane:a.state.rounds.length-1})},void(a.doGameEdit=function(b){a.edit.game=b,a.edit.rounds_pane=a.pane,a.goToState("game_edit")}))}]),angular.module("srApp.filters").filter("playerSort",["players",function(a){return function(b){return a.sort(b)}}]),angular.module("srApp.services").factory("player",[function(){var a=_.comparator(_.lt),b=_.comparator(_.gt);return{is:_.rcurry2(function(a,b){return a.name===b}),compare:function(c,d){var e=a(c.points.tournament,d.points.tournament);return 0===e&&(e=a(c.points.sos,d.points.sos)),0===e&&(e=a(c.points.control,d.points.control)),0===e&&(e=a(c.points.army,d.points.army)),0===e&&(e=b(c.name,d.name)),e},create:function(a,b,c){return{name:a,faction:b,city:c,points:{tournament:0,sos:0,control:0,army:0}}}}}]).factory("players",["player",function(a){var b={add:function(b,c,d){var e=_.reject(b,_.unary(a.is("Phantom"))).concat(c);return c.length%2===1&&(e=_.cat(e,d)),e},player:function(b,c){return _.find(b,_.unary(a.is(c)))},names:function(a){return _.map(a,_.partial(_.getPath,_,"name"))},sort:function(b){return b.slice().sort(a.compare).reverse()},sosFrom:function(a,c){return _.map(c,function(c){return b.player(a,c)}).reduce(function(a,b){return a+_.getPath(b,"points.tournament")},0)}};return b}]),angular.module("srApp.services").factory("game",[function(){var a={create:function(a,b,c){return{table:a,p1:{name:b,tournament:null,control:null,army:null},p2:{name:c,tournament:null,control:null,army:null}}},player:_.rcurry2(function(a,b){var c=_.getPath(a,"p1.name");return c===b?_.getPath(a,"p1"):_.getPath(a,"p2")}),opponentFor:_.rcurry2(function(a,b){var c=_.getPath(a,"p1.name");return c===b?_.getPath(a,"p2.name"):c}),successFor:_.rcurry2(function(b,c){var d=a.player(c)(b);return _.getPath(d||{},"tournament")}),tableFor:_.rcurry2(function(a){return _.getPath(a,"table")})};return a}]).factory("round",["game",function(){var a={gameFor:_.rcurry2(function(a,b){return _.find(a,function(a){return a.p1.name===b||a.p2.name===b})})};return a}]).factory("rounds",["game","round",function(a,b){var c={round:_.rcurry2(function(a,b){return b>=a.length?[]:a[b]}),pointsFor:function(c,d){return _.map(c,_.unary(b.gameFor(d))).map(_.unary(a.player(d))).reduce(function(a,b){return{tournament:a.tournament+b.tournament,control:a.control+b.control,army:a.army+b.army}},{tournament:0,control:0,army:0})},opponentsFor:function(c,d){return _.map(c,_.unary(b.gameFor(d))).map(_.unary(a.opponentFor(d)))},tablesFor:function(c,d){return _.map(c,_.unary(b.gameFor(d))).map(_.unary(a.tableFor(d)))},query:function(d,e,f,g){return _.pipeline(c.round(e),b.gameFor(f),a[g](f))(d)},suggestOpponentFor:function(a,b,d){var e=c.opponentsFor(a,d),f=_.difference(b,e);return 0===f.length?b[0]:f[0]},suggestTableFor:function(a,b,d,e){var f=c.tablesFor(a,d),g=c.tablesFor(a,e),h=_.difference(b,f,g);return 0===h.length?b[0]:h[0]},suggestNextRound:function(b,d){var e=d.length/2,f=d.slice(),g=_.range(1,e+1);return _.chain(_.range(e)).map(function(){var d=f[0];f=_.rest(f);var e=c.suggestOpponentFor(b,f,d);f=_.without(f,e);var h=c.suggestTableFor(b,g,d,e);return g=_.without(g,h),a.create(h,d,e)}).sortBy(_.property("table")).value()}};return c}]);