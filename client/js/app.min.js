"use strict";angular.module("srApp.services",[]),angular.module("srApp.filters",[]),angular.module("srApp.controllers",[]),angular.module("srApp",["ui.router","srApp.controllers","srApp.filters","srApp.services"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/players"),a.state("file",{url:"/file",templateUrl:"partials/file.html",controller:"fileCtrl",data:{}}).state("players",{url:"/players",templateUrl:"partials/players.html",controller:"playersCtrl",data:{}}).state("player_edit",{templateUrl:"partials/player_edit.html",controller:"playerEditCtrl",data:{}}).state("team_edit",{templateUrl:"partials/team_edit.html",controller:"teamEditCtrl",data:{}}).state("rounds",{url:"/rounds/:pane",templateUrl:"partials/rounds.html",controller:"roundsCtrl",data:{}}).state("game_edit",{templateUrl:"partials/game_edit.html",controller:"gameEditCtrl",data:{}}).state("ranking_edit",{url:"/ranking_edit",templateUrl:"partials/ranking_edit.html",controller:"rankingEditCtrl",data:{}})}]).config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob):/)}]),angular.module("srApp.controllers").controller("fileCtrl",["$scope","$window","backup",function(a,b,c){a.openFile=function(b){c.read(b).then(function(b){a.newState(b),a.goToState("players")},function(b){a.open_result=b})};var d=new Date;a.save_name="dating_"+d.getTime()+".txt",a.save_url=c.generate(a.state),a.$on("$destroy",function(){c.cleanup(a.save_url)}),a.doReset=function(){var c=0===a.state.teams.length&&0===a.state.players.length&&0===a.state.rounds.length;c||(c=b.confirm("You sure ?")),c&&a.resetState()}}]),angular.module("srApp.controllers").controller("gameEditCtrl",["$scope","$stateParams","rounds","players","teams","team_game",function(a,b,c,d,e,f){a.game=_.snapshot(a.edit.game),a.setWinLoss=function(a,b,c){a[b].tournament=1,a[c].tournament=0},a.close=function(b){b&&(_.extend(a.edit.game,a.game),a.updatePoints(),a.storeState()),a.goToState("rounds",{pane:a.edit.rounds_pane})},a.game.games&&a.$watch("game.games",function(){f.refreshPoints(a.game)},!0)}]),angular.module("srApp.controllers").controller("mainCtrl",["$scope","$state","$window","player","players","rounds","factions","team","teams",function(a,b,c,d,e,f,g,h,i){a.edit={},a.resetState=function(){a.newState({})},a.newState=function(b){a.state=_.defaults(b,{phantom:d.create("Phantom"),teams:[],players:[],rounds:[],factions:[],ranking:{player:"((tp*n_players^2+sos)*5*n_rounds+cp)*100*n_rounds+ap",team:"(((ttp*team_size*n_rounds+tp)*n_teams^2+sos)*5*n_rounds+cp)*100*n_rounds+ap"}}),a.state.factions=g.listFrom(a.state.players),a.storeState()},a.storeState=function(){c.localStorage.setItem("sdApp.state",JSON.stringify(a.state))},a.isTeamTournament=function(){return 0!==a.state.teams.length},a.goToState=_.bind(b.go,b),a.currentState=_.bind(_.getPath,_,b,"current.name"),a.doEditPlayer=function(b){a.edit.player=b,a.goToState("player_edit")},a.doEditTeam=function(b){a.edit.team=b,a.goToState("team_edit")},a.updatePoints=function(){_.chain(a.state.players).each(function(b){b.points=f.pointsFor(a.state.rounds,b.name)}).each(function(b){b.points.sos=e.sosFrom(a.state.players,f.opponentsFor(a.state.rounds,b.name))}),_.chain(a.state.teams).each(function(b){b.points=f.pointsForTeam(a.state.rounds,b.name)}).each(function(b){b.points.sos=i.sosFrom(a.state.teams,f.opponentsForTeam(a.state.rounds,b.name))})},a.show={},a.doShowAll=function(b,c){_.each(a.state.teams,function(c){a.show[c.name]=b}),c.stopPropagation()},a.doShow=function(b,c,d){a.show[b]=c,d.stopPropagation()};var j=c.localStorage.getItem("sdApp.state");if(j)try{j=JSON.parse(j),a.newState(j)}catch(k){}_.exists(a.state)||a.resetState()}]),angular.module("srApp.controllers").controller("playersCtrl",["$scope","$state","player","players","team","teams","$window",function(a,b,c,d,e,f,g){a.doAddPlayer=function(){a.edit.player=c.create(),a.goToState("player_edit")},a.doAddTeam=function(){a.edit.team=e.create(),a.goToState("team_edit")},a.doDeletePlayer=function(b,c){var e=g.confirm("You sure ?");e&&(a.state.players=d.drop(a.state.players,b,a.state.phantom),a.storeState()),c.stopPropagation()},a.doDeleteTeam=function(b,c){var e=g.confirm("You sure ?");e&&(a.state.teams=f.drop(a.state.teams,b),a.state.players=d.dropTeam(a.state.players,b.name),a.storeState()),c.stopPropagation()}}]).controller("playerEditCtrl",["$scope","players","player","factions","$window",function(a,b,c,d,e){a.state.factions=d.listFrom(a.state.players),a.state.cities=b.cities(a.state.players),a.player=_.snapshot(a.edit.player),a.doClose=function(c){if(c){if(!_.isString(a.player.name)||0>=a.player.name)return void e.alert("invalid player name");if(a.isTeamTournament()&&(!_.isString(a.player.team)||0>=a.player.team))return void e.alert("invalid player team");var d=b.names(a.state.players);if(_.exists(a.edit.player.name)&&(d=_.without(d,a.edit.player.name)),0<=_.indexOf(d,a.player.name))return void e.alert("a player with the same name already exists");_.exists(a.edit.player.name)?_.extend(a.edit.player,a.player):a.state.players=b.add(a.state.players,a.player,a.state.phantom),a.storeState()}a.goToState("players")}}]),angular.module("srApp.controllers").controller("rankingEditCtrl",["$scope","$window",function(a,b){function c(){a.player_ranking_valid=!0;var b;try{b=new Function("tp","sos","cp","ap","n_rounds","n_players","return "+a.player_test.ranking+";")}catch(c){return a.player_test.player1.rank="Error : "+c.message,a.player_test.player2.rank="Error : "+c.message,void(a.player_ranking_valid=!1)}try{a.player_test.player1.rank=b(a.player_test.player1.tp,a.player_test.player1.sos,a.player_test.player1.cp,a.player_test.player1.ap,a.player_test.n_rounds,a.player_test.n_players)}catch(c){a.player_test.player1.rank="Error : "+c.message,a.player_ranking_valid=!1}try{a.player_test.player2.rank=b(a.player_test.player2.tp,a.player_test.player2.sos,a.player_test.player2.cp,a.player_test.player2.ap,a.player_test.n_rounds,a.player_test.n_players)}catch(c){a.player_test.player2.rank="Error : "+c.message,a.player_ranking_valid=!1}}function d(){a.team_ranking_valid=!0;var b;try{b=new Function("ttp","tp","sos","cp","ap","n_teams","team_size","n_rounds","n_players","return "+a.team_test.ranking+";")}catch(c){return a.team_test.team1.rank="Error : "+c.message,a.team_test.team2.rank="Error : "+c.message,void(a.team_ranking_valid=!1)}try{a.team_test.team1.rank=b(a.team_test.team1.ttp,a.team_test.team1.tp,a.team_test.team1.sos,a.team_test.team1.cp,a.team_test.team1.ap,a.team_test.n_teams,a.team_test.team_size,a.team_test.n_rounds,a.team_test.n_teams)}catch(c){a.team_test.team1.rank="Error : "+c.message,a.team_ranking_valid=!1}try{a.team_test.team2.rank=b(a.team_test.team2.ttp,a.team_test.team2.tp,a.team_test.team2.sos,a.team_test.team2.cp,a.team_test.team2.ap,a.team_test.n_teams,a.team_test.team_size,a.team_test.n_rounds,a.team_test.n_teams)}catch(c){a.team_test.team2.rank="Error : "+c.message,a.team_ranking_valid=!1}}a.pane="player",a.player_test={ranking:a.state.ranking.player,n_rounds:5,n_players:32,player1:{tp:4,sos:10,cp:13,ap:38,rank:0},player2:{tp:3,sos:15,cp:8,ap:45,rank:0}},c(),a.$watch("player_test",function(){c()},!0),a.team_test={ranking:a.state.ranking.team,n_teams:8,team_size:5,n_rounds:3,n_players:40,team1:{ttp:2,tp:5,sos:10,cp:13,ap:38,rank:0},team2:{ttp:1,tp:4,sos:15,cp:8,ap:45,rank:0}},d(),a.$watch("team_test",function(){d()},!0),a.doReset=function(b){"player"===b&&(a.player_test.ranking="((tp*n_players^2+sos)*5*n_rounds+cp)*100*n_rounds+ap"),"team"===b&&(a.team_test.ranking="(((ttp*team_size*n_rounds+tp)*n_teams^2+sos)*5*n_rounds+cp)*100*n_rounds+ap")},a.doClose=function(c){if(c){if(!a.player_ranking_valid)return b.alert("current player ranking is invalid !"),void(a.pane="player");if(!a.team_ranking_valid)return b.alert("current team ranking is invalid !"),void(a.pane="team");a.state.ranking.player=a.player_test.ranking,a.state.ranking.team=a.team_test.ranking}a.goToState("players")}}]),angular.module("srApp.controllers").controller("roundsCtrl",["$scope","rounds","players","teams","$stateParams","$window",function(a,b,c,d,e,f){function g(c){a[c]=function(d,e){return b.query(a.state.rounds,e,d,c)}}function h(c){a[c]=function(d,e){return b.teamQuery(a.state.rounds,e,d,c)}}var i=_.chain(a.state.teams).map(function(b){return c.inTeam(a.state.players,b.name).length}).max().value();return a.doShowAllTables=function(b,c){_.chain(i).range().each(function(c){a.show["table"+(c+1)]=b}),c.stopPropagation()},a.doShowTable=function(b,c,d){a.show["table"+b]=c,d.stopPropagation()},a.pane=e.pane,a.pane>=a.state.rounds.length?void a.goToState("rounds",{pane:"sum"}):(a.roundsRange=function(){return _.range(a.state.rounds.length)},g("opponentFor"),g("successFor"),g("tableFor"),a.gameFor=function(c,d){return b.gameFor(a.state.rounds,c,d)},h("opponentForTeam"),h("successForTeam"),h("tableForTeam"),a.gameForTeam=function(c,d){return b.gameForTeam(a.state.rounds,c,d)},a.round=function(c){return b.round(a.state.rounds,c)},a.next_round=a.isTeamTournament()?_.chain(a.state.teams.length/2).range().map(function(a){return{table:a+1,t1:{name:null},t2:{name:null}}}).value():_.chain(a.state.players.length/2).range().map(function(a){return{table:a+1,p1:{name:null,tournament:null,control:null,army:null},p2:{name:null,tournament:null,control:null,army:null}}}).value(),a.playerNames=function(){return c.names(a.state.players)},a.teamNames=function(){return d.names(a.state.teams)},a.suggestNextRound=function(){if(a.isTeamTournament()){var e=_.chain(a.state.teams).apply(d.sort,a.state.ranking.team,a.state.players,a.state.rounds.length).apply(d.names).value();a.next_round=b.suggestNextTeamRound(a.state.rounds,e,i)}else{var f=_.chain(a.state.players).apply(c.sort,a.state.ranking.player,a.state.rounds.length).apply(c.names).value();a.next_round=b.suggestNextRound(a.state.rounds,f)}},a.registerNextRound=function(){a.state.rounds.push(a.next_round),a.storeState(),a.goToState("rounds",{pane:a.state.rounds.length-1})},a.doGameEdit=function(b){a.edit.game=b,a.edit.rounds_pane=a.pane,a.goToState("game_edit")},void(a.doDeleteRound=function(c){var d=f.confirm("You sure ?");d&&(a.state.rounds=b.drop(a.state.rounds,c),a.updatePoints(),a.storeState(),a.goToState("rounds",{pane:"sum"}))}))}]),angular.module("srApp.controllers").controller("teamEditCtrl",["$scope","players","player","factions","$window","teams",function(a,b,c,d,e,f){a.state.factions=d.listFrom(a.state.players),a.state.cities=f.cities(a.state.teams),a.team=_.snapshot(a.edit.team),a.doClose=function(b){if(b){if(!_.isString(a.team.name)||0>=a.team.name)return void e.alert("invalid team info");var c=f.names(a.state.teams);if(_.exists(a.edit.team.name)&&(c=_.without(c,a.edit.team.name)),0<=_.indexOf(c,a.team.name))return void e.alert("a team with the same name already exists");_.exists(a.edit.team.name)?_.extend(a.edit.team,a.team):a.state.teams=f.add(a.state.teams,a.team),a.storeState()}a.goToState("players")}}]),angular.module("srApp.filters").filter("factionIcon",["factions",function(a){return function(b){return a.iconFor(b)}}]),angular.module("srApp.filters").filter("playerSort",["players",function(a){return function(b,c,d){return a.sort(b,c,d.length)}}]),angular.module("srApp.filters").filter("playersInTeam",["players",function(a){return function(b,c){return a.inTeam(b,c)}}]),angular.module("srApp.filters").filter("teamSort",["teams",function(a){return function(b,c,d,e){return a.sort(b,c,d,e.length)}}]),_.mixin({apply:function(a,b){var c=_.rest(_.rest(arguments));return b.apply(null,_.cons(a,c))}}),_.mixin({mapWith:function(a,b){var c=_.rest(_.rest(arguments)),d=_.partial.apply(null,_.cat([b,_],c));return _.map(a,d)}}),angular.module("srApp.services").factory("backup",["$window","$q",function(a,b){return a.URL=a.URL||a.webkitURL,{read:function(c){var d=new a.FileReader,e=b.defer();return d.onload=function(a){var b;try{b=JSON.parse(a.target.result),e.resolve(b)}catch(c){e.reject("invalid file")}},d.onerror=function(){e.reject("error reading file")},d.onabort=function(){e.reject("abort reading file")},d.readAsText(c),e.promise},generate:function(b){return _.chain(b).apply(JSON.stringify).apply(function(b){return new a.Blob([b],{type:"text/plain"})}).apply(a.URL.createObjectURL).value()},cleanup:function(b){null!==b&&a.URL.revokeObjectURL(b)}}}]),angular.module("srApp.services").factory("factions",["$window","$http",function(a,b){var c;return b.get("data/factions.json").then(function(a){c=a.data},function(a){}),{listFrom:function(a){return _.chain(a).mapWith(_.getPath,"faction").cat(_.keys(c)).uniq().without(void 0).sort().value()},iconFor:function(a){return _.chain(a).apply(function(a){return _.exists(c[a])?c[a].icon:void 0}).apply(function(a){return _.exists(a)?"data/icons/"+a:""}).value()}}}]),angular.module("srApp.services").factory("player",[function(){return{is:_.rcurry2(function(a,b){return a.name===b}),inTeam:_.rcurry2(function(a,b){return a.team===b}),rank:function(a,b){var c=b(a.points.tournament,a.points.sos,a.points.control,a.points.army);return c},create:function(a,b,c,d){return{name:a,faction:b,city:c,team:d,points:{tournament:0,sos:0,control:0,army:0}}}}}]).factory("players",["player",function(a){var b={appendPhantom:function(a,b){return a.length%2===1?_.cat(a,b):a},add:function(c,d,e){return _.chain(c).reject(_.unary(a.is("Phantom"))).cat(d).apply(b.appendPhantom,e).value()},drop:function(c,d,e){return _.chain(c).reject(_.unary(a.is(d.name))).reject(_.unary(a.is("Phantom"))).apply(b.appendPhantom,e).value()},player:function(b,c){return _.find(b,_.unary(a.is(c)))},names:function(a){return _.mapWith(a,_.getPath,"name")},cities:function(a){return _.chain(a).mapWith(_.getPath,"city").uniq().without(void 0).value()},sort:function(b,c,d){var e=new Function("tp","sos","cp","ap","n_players","n_rounds","return "+c+";"),f=_.partial(e,_,_,_,_,b.length,d);return _.sortBy(b.slice(),_.partial(a.rank,_,f)).reverse()},sosFrom:function(a,c){return _.chain(c).map(_.partial(b.player,a)).reduce(function(a,b){return a+_.getPath(b,"points.tournament")},0).value()},inTeam:function(b,c){return _.chain(b).select(_.unary(a.inTeam(c))).value()},dropTeam:function(b,c){return _.reject(b,_.unary(a.inTeam(c)))}};return b}]),angular.module("srApp.services").factory("game",[function(){var a={create:function(a,b,c){return{table:a,p1:{name:b,tournament:null,control:null,army:null},p2:{name:c,tournament:null,control:null,army:null}}},player:function(a,b){var c=_.getPath(a,"p1.name");return c===b?_.getPath(a,"p1"):_.getPath(a,"p2")},opponentFor:function(a,b){var c=_.getPath(a,"p1.name");return c===b?_.getPath(a,"p2.name"):c},successFor:function(b,c){return _.chain(b).apply(a.player,c).getPath("tournament").value()},tableFor:_.partial(_.getPath,_,"table")};return a}]).factory("team_game",["game",function(a){var b={create:function(b,c,d,e){return{table:b,t1:{name:c,team_tournament:null,tournament:null,control:null,army:null},t2:{name:d,team_tournament:null,tournament:null,control:null,army:null},games:_.chain(e).range().map(function(){return a.create(b)}).value()}},team:function(a,b){var c=_.getPath(a,"t1.name");return c===b?_.getPath(a,"t1"):_.getPath(a,"t2")},opponentForTeam:function(a,b){var c=_.getPath(a,"t1.name");return c===b?_.getPath(a,"t2.name"):c},successForTeam:function(a,c){return _.chain(a).apply(b.team,c).getPath("team_tournament").value()},tableForTeam:_.partial(_.getPath,_,"table"),refreshPoints:function(a){var b=_.chain(a.games).reduce(function(a,b){return{t1:{tournament:a.t1.tournament+(b.p1.tournament||0),control:a.t1.control+(b.p1.control||0),army:a.t1.army+(b.p1.army||0)},t2:{tournament:a.t2.tournament+(b.p2.tournament||0),control:a.t2.control+(b.p2.control||0),army:a.t2.army+(b.p2.army||0)}}},{t1:{tournament:0,control:0,army:0},t2:{tournament:0,control:0,army:0}}).value();_.extend(a.t1,b.t1),_.extend(a.t2,b.t2),a.t1.team_tournament=a.t1.tournament>a.t2.tournament?1:a.t1.tournament<a.t2.tournament?0:null,a.t2.team_tournament=a.t2.tournament>a.t1.tournament?1:a.t2.tournament<a.t1.tournament?0:null}};return b}]).factory("round",["game",function(){var a={gameFor:function(a,b){return _.isArray(a)&&0!==a.length?_.exists(a[0].games)?_.chain(a).map(function(a){return _.getPath(a,"games")}).map(function(a){return _.find(a,function(a){return a.p1.name===b||a.p2.name===b})}).without(void 0).first().value():_.find(a,function(a){return a.p1.name===b||a.p2.name===b}):[]},gameForTeam:function(a,b){return _.find(a,function(a){return a.t1.name===b||a.t2.name===b})}};return a}]).factory("rounds",["game","team_game","round",function(a,b,c){var d={round:function(a,b){return b>=a.length?[]:a[b]},drop:function(a,b){var c=a.slice();return c.splice(b,1),c},pointsFor:function(b,d){return _.chain(b).mapWith(c.gameFor,d).mapWith(a.player,d).reduce(function(a,b){return{tournament:a.tournament+b.tournament,control:a.control+b.control,army:a.army+b.army}},{tournament:0,control:0,army:0}).value()},pointsForTeam:function(a,d){return _.chain(a).mapWith(c.gameForTeam,d).mapWith(b.team,d).reduce(function(a,b){return{team_tournament:a.team_tournament+b.team_tournament,tournament:a.tournament+b.tournament,control:a.control+b.control,army:a.army+b.army}},{team_tournament:0,tournament:0,control:0,army:0}).value()},opponentsFor:function(b,d){return _.chain(b).mapWith(c.gameFor,d).mapWith(a.opponentFor,d).value()},opponentsForTeam:function(a,d){return _.chain(a).mapWith(c.gameForTeam,d).mapWith(b.opponentForTeam,d).value()},tablesFor:function(b,d){return _.chain(b).mapWith(c.gameFor,d).mapWith(a.tableFor,d).value()},tablesForTeam:function(a,d){return _.chain(a).mapWith(c.gameForTeam,d).mapWith(b.tableForTeam,d).value()},gameFor:function(a,b,e){return _.chain(a).apply(d.round,e).apply(c.gameFor,b).value()},gameForTeam:function(a,b,e){return _.chain(a).apply(d.round,e).apply(c.gameForTeam,b).value()},query:function(b,e,f,g){return _.chain(b).apply(d.round,e).apply(c.gameFor,f).apply(a[g],f).value()},teamQuery:function(a,e,f,g){return _.chain(a).apply(d.round,e).apply(c.gameForTeam,f).apply(b[g],f).value()},suggestOpponentFor:function(a,b,c){var e=d.opponentsFor(a,c),f=_.difference(b,e);return 0===f.length?b[0]:f[0]},suggestTableFor:function(a,b,c,e){var f=d.tablesFor(a,c),g=d.tablesFor(a,e),h=_.difference(b,f,g);return 0===h.length?b[0]:h[0]},suggestNextRound:function(b,c){var e=c.length/2,f=c.slice(),g=_.range(1,e+1);return _.chain(_.range(e)).map(function(){var c=f[0];f=_.rest(f);var e=d.suggestOpponentFor(b,f,c);f=_.without(f,e);var h=d.suggestTableFor(b,g,c,e);return g=_.without(g,h),a.create(h,c,e)}).sortBy(_.property("table")).value()},suggestOpponentForTeam:function(a,b,c){var e=d.opponentsForTeam(a,c),f=_.difference(b,e);return 0===f.length?b[0]:f[0]},suggestTableForTeam:function(a,b,c,e){var f=d.tablesForTeam(a,c),g=d.tablesForTeam(a,e),h=_.difference(b,f,g);return 0===h.length?b[0]:h[0]},suggestNextTeamRound:function(a,c,e){var f=c.length/2,g=c.slice(),h=_.range(1,f+1);return _.chain(_.range(f)).map(function(){var c=g[0];g=_.rest(g);var f=d.suggestOpponentForTeam(a,g,c);g=_.without(g,f);var i=d.suggestTableForTeam(a,h,c,f);return h=_.without(h,i),b.create(i,c,f,e)}).sortBy(_.property("table")).value()}};return d}]),angular.module("srApp.services").factory("team",[function(){return{is:_.rcurry2(function(a,b){return a.name===b}),rank:function(a,b){var c=b(a.points.team_tournament,a.points.tournament,a.points.sos,a.points.control,a.points.army);return c},create:function(a,b){return{name:a,city:b,points:{team_tournament:0,tournament:0,sos:0,control:0,army:0}}}}}]).factory("teams",["team","players",function(a,b){var c={add:function(a,b){return _.cat(a,b)},drop:function(b,c){return _.reject(b,_.unary(a.is(c.name)))},team:function(b,c){return _.find(b,_.unary(a.is(c)))},names:function(a){return _.mapWith(a,_.getPath,"name")},cities:function(a){return _.chain(a).mapWith(_.getPath,"city").uniq().without(void 0).value()},sort:function(c,d,e,f){var g=new Function("ttp","tp","sos","cp","ap","team_size","n_teams","n_players","n_rounds","return "+d+";"),h=_.chain(c).map(function(a){return b.inTeam(e,a.name).length}).max().value(),i=_.partial(g,_,_,_,_,_,h,c.length,e.length,f);return _.sortBy(c.slice(),_.partial(a.rank,_,i)).reverse()},sosFrom:function(a,b){return _.chain(b).map(_.partial(c.team,a)).reduce(function(a,b){return a+_.getPath(b,"points.team_tournament")},0).value()}};return c}]);