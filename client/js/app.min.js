"use strict";angular.module("srApp.services",[]),angular.module("srApp.filters",[]),angular.module("srApp.controllers",[]),angular.module("srApp.directives",[]),angular.module("srApp",["ui.router","srApp.controllers","srApp.filters","srApp.services","srApp.directives"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/players"),a.state("players",{url:"/players",templateUrl:"partials/players.html",controller:"playersCtrl",data:{}})}]).config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob):/)}]),angular.module("srApp.controllers").controller("fileCtrl",["$scope","$window","backup","t3Import","exporter",function(a,b,c,d,e){a.openFile=function(b){c.read(b).then(function(b){a.newState(b),a.goToState("players")},function(b){a.open_result=b})};var f=new Date;a.save_name="dating_"+f.getTime()+".txt",a.save_url=c.generate(a.state),a.csv_name="dating_"+f.getTime()+".csv",a.csv_url=e.generate("csv",a.state),a.bb_name="dating_"+f.getTime()+".txt",a.bb_url=e.generate("bb",a.state),a.$on("$destroy",function(){c.cleanup(a.save_url),c.cleanup(a.csv_url),c.cleanup(a.bb_url)}),a.doReset=function(){var c=0===a.state.teams.length&&0===a.state.players.length&&0===a.state.rounds.length;c||(c=b.confirm("You sure ?")),c&&a.resetState()},a.importT3File=function(b){d.read(b).then(function(b){a.newState({players:[b]}),a.goToState("players")},function(b){a.import_t3_result=b})}}]),angular.module("srApp.controllers").controller("gameEditCtrl",["$scope","$stateParams","rounds","players","teams","team_game","lists","factions",function(a,b,c,d,e,f,g){a.game=_.snapshot(a.edit.game),a.setWinLoss=function(a,b,c){a[b].tournament=1,a[c].tournament=0},a.close=function(b){b&&(_.extend(a.edit.game,a.game),a.updatePoints(),a.storeState()),a.goToState("rounds",{pane:a.edit.rounds_pane})},a.casters={},a.game.games?(a.$watch("game.games",function(){f.refreshPoints(a.game)},!0),_.chain(a.state.players).apply(d.inTeam,a.game.t1.name).each(function(b){a.casters[b.name]=g.casters(b.lists)}),_.chain(a.state.players).apply(d.inTeam,a.game.t2.name).each(function(b){a.casters[b.name]=g.casters(b.lists)})):(a.casters.p1=_.chain(a.state.players).apply(d.player,a.game.p1.name).apply(_.getPath,"lists").apply(g.casters).value(),a.casters.p2=_.chain(a.state.players).apply(d.player,a.game.p2.name).apply(_.getPath,"lists").apply(g.casters).value())}]),angular.module("srApp.controllers").controller("mainCtrl",["$scope","state",function(a,b){a.state=b.init()}]),angular.module("srApp.controllers").controller("playersCtrl",["$scope","$state","$window","player","players",function(){}]),angular.module("srApp.controllers").controller("rankingEditCtrl",["$scope","$window",function(a,b){function c(){a.player_ranking_valid=!0;var b;try{b=new Function("tp","sos","cp","ap","n_rounds","n_players","return "+a.player_test.ranking+";")}catch(c){return a.player_test.player1.rank="Error : "+c.message,a.player_test.player2.rank="Error : "+c.message,void(a.player_ranking_valid=!1)}try{a.player_test.player1.rank=b(a.player_test.player1.tp,a.player_test.player1.sos,a.player_test.player1.cp,a.player_test.player1.ap,a.player_test.n_rounds,a.player_test.n_players)}catch(c){a.player_test.player1.rank="Error : "+c.message,a.player_ranking_valid=!1}try{a.player_test.player2.rank=b(a.player_test.player2.tp,a.player_test.player2.sos,a.player_test.player2.cp,a.player_test.player2.ap,a.player_test.n_rounds,a.player_test.n_players)}catch(c){a.player_test.player2.rank="Error : "+c.message,a.player_ranking_valid=!1}}function d(){a.team_ranking_valid=!0;var b;try{b=new Function("ttp","tp","sos","cp","ap","n_teams","team_size","n_rounds","n_players","return "+a.team_test.ranking+";")}catch(c){return a.team_test.team1.rank="Error : "+c.message,a.team_test.team2.rank="Error : "+c.message,void(a.team_ranking_valid=!1)}try{a.team_test.team1.rank=b(a.team_test.team1.ttp,a.team_test.team1.tp,a.team_test.team1.sos,a.team_test.team1.cp,a.team_test.team1.ap,a.team_test.n_teams,a.team_test.team_size,a.team_test.n_rounds,a.team_test.n_teams)}catch(c){a.team_test.team1.rank="Error : "+c.message,a.team_ranking_valid=!1}try{a.team_test.team2.rank=b(a.team_test.team2.ttp,a.team_test.team2.tp,a.team_test.team2.sos,a.team_test.team2.cp,a.team_test.team2.ap,a.team_test.n_teams,a.team_test.team_size,a.team_test.n_rounds,a.team_test.n_teams)}catch(c){a.team_test.team2.rank="Error : "+c.message,a.team_ranking_valid=!1}}a.pane="player",a.player_test={ranking:a.state.ranking.player,n_rounds:5,n_players:32,player1:{tp:4,sos:10,cp:13,ap:38,rank:0},player2:{tp:3,sos:15,cp:8,ap:45,rank:0}},c(),a.$watch("player_test",function(){c()},!0),a.team_test={ranking:a.state.ranking.team,n_teams:8,team_size:5,n_rounds:3,n_players:40,team1:{ttp:2,tp:5,sos:10,cp:13,ap:38,rank:0},team2:{ttp:1,tp:4,sos:15,cp:8,ap:45,rank:0}},d(),a.$watch("team_test",function(){d()},!0),a.doReset=function(b){"player"===b&&(a.player_test.ranking="((tp*n_players*n_players+sos)*5*n_rounds+cp)*100*n_rounds+ap"),"team"===b&&(a.team_test.ranking="(((ttp*team_size*n_rounds+tp)*n_teams*n_teams+sos)*5*n_rounds+cp)*100*n_rounds+ap")},a.doClose=function(c){if(c){if(!a.player_ranking_valid)return b.alert("current player ranking is invalid !"),void(a.pane="player");if(!a.team_ranking_valid)return b.alert("current team ranking is invalid !"),void(a.pane="team");a.state.ranking.player=a.player_test.ranking,a.state.ranking.team=a.team_test.ranking,a.storeState()}a.goToState("players")}}]),angular.module("srApp.controllers").controller("roundsCtrl",["$scope","rounds","players","teams","pairing","$stateParams","$window",function(a,b,c,d,e,f,g){function h(c){a[c]=function(d,e){return b.query(a.state.rounds,e,d,c)}}function i(c){a[c]=function(d,e){return b.teamQuery(a.state.rounds,e,d,c)}}var j=a.isTeamTournament()?_.flatten(a.state.teams).length/2:_.flatten(a.state.players).length/2;if(a.doShowAllTables=function(b,c){_.chain(j).range().each(function(c){a.show["table"+(c+1)]=b}),c.stopPropagation()},a.doShowTable=function(b,c,d){a.show["table"+b]=c,d.stopPropagation()},a.pane=f.pane,a.pane>=a.state.rounds.length)return void a.goToState("rounds",{pane:"sum"});a.roundsRange=function(){return _.range(a.state.rounds.length)},h("opponentFor"),h("successFor"),h("tableFor"),a.gameFor=function(c,d){return b.gameFor(a.state.rounds,c,d)},i("opponentForTeam"),i("successForTeam"),i("tableForTeam"),a.gameForTeam=function(c,d){return b.gameForTeam(a.state.rounds,c,d)},a.round=function(c,d){var e,f;return a.isTeamTournament()?(e=_.chain(a.state.teams).slice(0,d).flatten().value().length/2,f=e+a.state.teams[d].length/2,_.chain(a.state.rounds).apply(b.round,c).slice(e,f).value()):(e=_.chain(a.state.players).slice(0,d).flatten().value().length/2,f=e+a.state.players[d].length/2,_.chain(a.state.rounds).apply(b.round,c).slice(e,f).value())},a.next_round=a.isTeamTournament()?_.map(a.state.teams,function(a){return _.chain(a.length/2).range().map(function(a){return{table:a+1,t1:{name:null},t2:{name:null}}}).value()}):_.map(a.state.players,function(a){return _.chain(a.length/2).range().map(function(a){return{table:a+1,p1:{name:null,tournament:null,control:null,army:null},p2:{name:null,tournament:null,control:null,army:null}}}).value()}),a.playerNames=function(a){return c.names(a)},a.teamNames=function(a){return d.names(a)},a.bracket=_.snapshot(a.state.bracket);var k=a.isTeamTournament()?a.state.teams.length:a.state.players.length;a.bracket.length!==k&&(a.bracket=_.repeat(k,void 0)),a.suggestNextRound=function(b,c){c?_.exists(a.bracket[b])||(a.bracket[b]=a.state.rounds.length):_.exists(a.bracket[b])&&(a.bracket[b]=void 0),a.next_round[b]=e.suggestRound(a.state,b,a.bracket[b])},a.registerNextRound=function(){a.state.bracket=a.bracket,a.state.rounds.push(_.flatten(a.next_round)),a.storeState(),a.goToState("rounds",{pane:a.state.rounds.length-1})},a.doGameEdit=function(b){a.edit.game=b,a.edit.rounds_pane=a.pane,a.goToState("game_edit")},a.doDeleteRound=function(c){var d=g.confirm("You sure ?");d&&(a.state.rounds=b.drop(a.state.rounds,c),_.each(a.state.bracket,function(b,c){_.exists(b)&&a.state.rounds.length<=b&&(a.state.bracket[c]=void 0)}),a.updatePoints(),a.storeState(),a.goToState("rounds",{pane:"sum"}))}}]),angular.module("srApp.controllers").controller("statsCtrl",["$scope","$window","$stateParams","factions","round","game",function(a,b,c,d,e,f){a.pane=c.pane;var g=_.flatten(a.state.players).length;a.player_stats={},d.baseFactions().then(function(){var b=0;a.player_stats.factions=_.chain(_.flatten(a.state.players)).countBy(function(a){return a.faction}).map(function(a,b){return _.extend({count:a},d.info(b))}).sortBy(function(a){return-a.count}).each(function(a){var c=2*Math.PI*b/g;a.start={x:100+75*Math.sin(c),y:100-76*Math.cos(c)};var d=2*Math.PI*(b+a.count)/g;a.end={x:100+75*Math.sin(d),y:100-76*Math.cos(d)},b+=a.count}).tap(function(a){}).value()});var h={};_.chain(_.flatten(a.state.players)).each(function(b){h[b.name]=_.chain(a.state.rounds).map(function(a){return e.gameFor(a,b.name)}).reduce(function(a,c){return f.successFor(c,b.name)?a[0]++:a[1]++,a},[0,0]).value()}).value();var i=_.chain(_.flatten(a.state.players)).map(function(a){return a.faction}).uniq().without(void 0).map(function(b){return{name:b,wl:_.chain(_.flatten(a.state.players)).where({faction:b}).reduce(function(a,b){return a[0]+=h[b.name][0],a[1]+=h[b.name][1],a},[0,0]).apply(function(a){return _.cat(a,a[0]+a[1])}).value()}}).sortBy(function(a){return a.wl[0]/a.wl[2]}).reverse().value();a.faction_win_loss=i}]),angular.module("srApp.controllers").controller("teamEditCtrl",["$scope","players","player","factions","$window","teams",function(a,b,c,d,e,f){a.state.factions=b.factions(a.state.players),a.state.cities=f.cities(a.state.teams),a.team=_.snapshot(a.edit.team),a.doClose=function(b){if(b){if(!_.isString(a.team.name)||0>=a.team.name)return void e.alert("invalid team info");var c=f.names(a.state.teams);if(_.exists(a.edit.team.name)&&(c=_.without(c,a.edit.team.name)),0<=_.indexOf(c,a.team.name))return void e.alert("a team with the same name already exists");_.exists(a.edit.team.name)?_.extend(a.edit.team,a.team):a.state.teams=f.add(a.state.teams,a.team,a.edit.group),a.storeState()}a.goToState("players")}}]),angular.module("srApp.directives").factory("appCache",["$window","$rootScope",function(a){function b(a){var b="progress"===a.type;c.progress=b?(c.progress+1)%100:0,c.onProgress(b)}var c={progress:0,onProgress:function(){},onUpdateReady:function(){}},d=a.applicationCache;return d.addEventListener("cached",b,!1),d.addEventListener("checking",b,!1),d.addEventListener("downloading",b,!1),d.addEventListener("error",b,!1),d.addEventListener("noupdate",b,!1),d.addEventListener("obsolete",b,!1),d.addEventListener("progress",b,!1),d.addEventListener("updateready",function(a){d.status===d.UPDATEREADY&&c.onUpdateReady(),c.progress=0,c.onProgress(!1)},!1),c}]).directive("appCacheProgressBar",function(){return{restrict:"E",template:'<div class="appcache-progress"     ng-show="appCache.progress != 0">  <div class="appcache-progress-bar"       ng-style="{\'width\': appCache.progress + \'%\' }"></div></div>',controller:["$scope","$window","appCache",function(a,b,c){a.appCache=c,c.onProgress=function(){a.$digest()},c.onUpdateReady=function(){b.confirm("A new version of this site is available. Load it?")&&b.location.reload()}}],link:function(){}}}),angular.module("srApp.filters").filter("factions",["factions",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]),angular.module("srApp.filters").filter("players",["players",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]),angular.module("srApp.filters").filter("state",["state",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]),angular.module("srApp.filters").filter("teams",["teams",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]),_.mixin({apply:function(a,b){var c=_.rest(_.rest(arguments));return b.apply(null,_.cons(a,c))}}),_.mixin({mapWith:function(a,b){var c=_.rest(_.rest(arguments)),d=_.partial.apply(null,_.cat([b,_],c));return _.map(a,d)}}),_.mixin({spy:function(a){var b=_.rest(arguments);return console.log.apply(console,_.cat(b,[a])),a}}),angular.module("srApp.services").factory("backup",["$window","$q",function(a,b){return a.URL=a.URL||a.webkitURL,{read:function(c){var d=new a.FileReader,e=b.defer();return d.onload=function(a){var b;try{b=JSON.parse(a.target.result),e.resolve(b)}catch(c){e.reject("invalid file")}},d.onerror=function(){e.reject("error reading file")},d.onabort=function(){e.reject("abort reading file")},d.readAsText(c),e.promise},generate:function(b){return _.chain(b).apply(JSON.stringify).apply(function(b){return new a.Blob([b],{type:"text/plain"})}).apply(a.URL.createObjectURL).value()},cleanup:function(b){null!==b&&a.URL.revokeObjectURL(b)}}}]),angular.module("srApp.services").factory("export_keys",[function(){return{team:["name","city","points.team_tournament","points.tournament","points.sos","points.control","points.army"],player:["name","team","city","faction","lists","points.tournament","points.sos","points.control","points.army"],team_game:["table","t1.tournament","t1.control","t1.army","p1.list","t1.name","t1.team_tournament","t2.team_tournament","t2.name","p2.list","t2.army","t2.control","t2.tournament"],game:["table","p1.control","p1.army","p1.list","p1.name","p1.tournament","p2.tournament","p2.name","p2.list","p2.army","p2.control"]}}]).factory("CSV",["export_keys","teams","players","lists",function(a,b,c,d){var e={stringifyObject:function(a,b){var c="";return c+=_.reduce(b,function(b,c){var d=_.getPath(a,c);return b+(_.exists(d)?d:"")+","},"")+"\r\n"},stringifyPlayers:function(b,c){var d="";return d+="Players\r\n",d+=_.reduce(a.player,function(a,b){return a+b+","},"")+"\r\n",d+=_.chain(b).apply(function(a){return c?_.sortBy(a,_.partial(_.getPath,_,"team")):a}).reduce(function(b,c){return b+e.stringifyObject(c,a.player)},"").value()},stringifyTeams:function(b){var c="";return c+="Teams\r\n",c+=_.reduce(a.team,function(a,b){return a+b+","},"")+"\r\n",c+=_.chain(b).reduce(function(b,c){return b+e.stringifyObject(c,a.team)},"").value()},stringifyGames:function(b){var c="";return c+=_.reduce(a.game,function(a,b){return a+b+","},"")+"\r\n",c+=_.chain(b).reduce(function(b,c){return b+e.stringifyObject(c,a.game)},"").value()},stringifyTeamGames:function(b){var c="";return c+=_.reduce(a.team_game,function(a,b){return a+b+","},"")+"\r\n",c+=_.chain(b).reduce(function(b,c){return b+=e.stringifyObject(c,a.team_game),b+=_.reduce(c.games,function(b,c){return b+","+e.stringifyObject(c,a.game)},"")},"").value()},stringifyRounds:function(a,b){var c="";return c+="Rounds\r\n",c+=_.chain(a).reduce(function(a,c,d){return a+="Round"+(d+1)+"\r\n",a+=b?e.stringifyTeamGames(c):e.stringifyGames(c)},"").value()},stringify:function(a){var f=0!==a.teams.length,g="";f&&(g+=e.stringifyTeams(b.sort(a.teams,a))+"\r\n");var h=_.chain(a.players).snapshot().apply(c.sort,a).each(function(a){a.lists=d.casters(a.lists).join(" ")}).value();return g+=e.stringifyPlayers(h,f)+"\r\n",g+=e.stringifyRounds(a.rounds,f)+"\r\n"}};return e}]).factory("BB",["export_keys","teams","players","lists",function(a,b,c,d){var e={stringifyObject:function(a,b,c){c=c||"";var d="";return d+="[tr]"+c+_.reduce(b,function(b,c){var d=_.getPath(a,c);return b+"[td]"+(_.exists(d)?d:"")+"[/td]"},"")+"[/tr]\r\n"},stringifyPlayers:function(b,c){var d="";return d+="[b]Players[/b]\r\n",d+="[table]\r\n",d+="[tr]"+_.reduce(a.player,function(a,b){return a+"[td][b]"+b+"[/b][/td]"},"")+"[/tr]\r\n",d+=_.chain(b).apply(function(a){return c?_.sortBy(a,_.partial(_.getPath,_,"team")):a}).reduce(function(b,c){return b+e.stringifyObject(c,a.player)},"").value(),d+="[/table]\r\n"},stringifyTeams:function(b){var c="";return c+="[b]Teams[/b]\r\n",c+="[table]\r\n",c+="[tr]"+_.reduce(a.team,function(a,b){return a+"[td][b]"+b+"[/b][/td]"},"")+"[/tr]\r\n",c+=_.chain(b).reduce(function(b,c){return b+e.stringifyObject(c,a.team)},"").value(),c+="[/table]\r\n"},stringifyGames:function(b){var c="";return c+="[table]\r\n",c+="[tr]"+_.reduce(a.game,function(a,b){return a+"[td][b]"+b+"[/b][/td]"},"")+"[/tr]\r\n",c+=_.chain(b).reduce(function(b,c){return b+e.stringifyObject(c,a.game)},"").value(),c+="[/table]\r\n"},stringifyTeamGames:function(b){var c="";return c+="[table]\r\n",c+="[tr]"+_.reduce(a.team_game,function(a,b){return a+"[td][b]"+b+"[/b][/td]"},"")+"[/tr]\r\n",c+=_.chain(b).reduce(function(b,c){return b+=e.stringifyObject(c,a.team_game),b+=_.reduce(c.games,function(b,c){return b+e.stringifyObject(c,a.game,"[td][/td]")},"")},"").value(),c+="[/table]\r\n"},stringifyRounds:function(a,b){var c="";return c+="[b]Rounds[/b]\r\n",c+=_.chain(a).reduce(function(a,c,d){return a+="Round"+(d+1)+"\r\n",a+=b?e.stringifyTeamGames(c):e.stringifyGames(c)},"").value()},stringify:function(a){var f=0!==a.teams.length,g="";f&&(g+=e.stringifyTeams(b.sort(a.teams,a))+"\r\n");var h=_.chain(a.players).snapshot().apply(c.sort,a).each(function(a){a.lists=d.casters(a.lists).join(" ")}).value();return g+=e.stringifyPlayers(h,f)+"\r\n",g+=e.stringifyRounds(a.rounds,f)+"\r\n"}};return e}]).factory("exporter",["$window","CSV","BB",function(a,b,c){a.URL=a.URL||a.webkitURL;var d={csv:b,bb:c};return{generate:function(b,c){return _.chain(c).apply(d[b].stringify).apply(function(b){return new a.Blob([b],{type:"text/plain"})}).apply(a.URL.createObjectURL).value()},cleanup:function(b){null!==b&&a.URL.revokeObjectURL(b)}}}]),angular.module("srApp.services").factory("factions",["$window","$http","$q",function(a,b,c){var d,e=[];return b.get("data/factions.json").then(function(a){d=a.data,_.each(e,function(a){a.resolve(d)})},function(a){}),{baseFactions:function(){if(_.exists(d))return d;var a=c.defer();return e.push(a),a.promise},iconFor:function(a){return _.chain(a).apply(function(a){var b=d||{};return _.exists(b[a])?d[a].icon:void 0}).apply(function(a){return _.exists(a)?"data/icons/"+a:""}).value()}}}]),angular.module("srApp.services").factory("list",[function(){return{create:function(a,b,c,d){return{faction:a,caster:b,theme:c,fk:d}}}}]).factory("lists",["list",function(){var a={add:function(a,b){return _.cat(a,b)},drop:function(a,b){var c=a.slice();return c.splice(b,1),c},casters:function(a){return _.mapWith(a,_.getPath,"caster")}};return a}]),angular.module("srApp.services").factory("basePairing",["rounds",function(a){var b={suggestTableFor:function(b,c,d,e){var f=a.tablesFor(b,d),g=a.tablesFor(b,e),h=_.difference(c,f,g);return 0===h.length?c[0]:h[0]},suggestTableForTeam:function(b,c,d,e){var f=a.tablesForTeam(b,d),g=a.tablesForTeam(b,e),h=_.difference(c,f,g);return 0===h.length?c[0]:h[0]}};return b}]).factory("bracketPairing",["basePairing","game","team_game","round","players","teams",function(a,b,c,d,e,f){var g={indices:function(a){return 2===a?[[1,2]]:_.chain(g.indices(a/2)).map(function(b){return[[b[0],a+1-b[0]],[a+1-b[1],b[1]]]}).reduce(function(a,b){return _.cat(a,b)},[]).value()},suggestFirstSingleRound:function(c,d){var f=(_.flatten(c.players).length/2,_.chain(c.players).slice(0,d).flatten().value().length/2+1),h=f+c.players[d].length/2,i=_.range(f,h),j=c.players[d],k=e.sortGroup(j,d,c);return _.chain(j.length).apply(g.indices).map(function(d){var e=k[d[0]-1].name,f=k[d[1]-1].name,g=a.suggestTableFor(c.rounds,i,e,f);return i=_.without(i,g),b.create(g,e,f)}).value()},suggestNextSingleRound:function(c,e){var f=_.flatten(c.players[e]).length/2,g=_.chain(c.players).slice(0,e).flatten().value().length/2+1,h=g+c.players[e].length/2,i=_.range(g,h),j=c.players[e],k=c.rounds.length-c.bracket[e],l=_.chain(c.players).slice(0,e).flatten().value().length/2,m=l+j.length/2;return _.chain(c.rounds).last().slice(l,m).chunk(f/(1<<k-1)).reduce(function(e,f){var g=_.chain(f).apply(d.winners).value(),h=_.chain(f).apply(d.losers).value(),j=_.chain(g).cat(h).chunk(2).value();return _.cat(e,_.map(j,function(d){var e=a.suggestTableFor(c.rounds,i,d[0],d[1]);return i=_.without(i,e),b.create(e,d[0],d[1])}))},[]).value()},suggestFirstTeamRound:function(b,d){var e=(_.flatten(b.teams).length/2,_.chain(b.teams).slice(0,d).flatten().value().length/2+1),h=e+b.teams[d].length/2,i=_.range(e,h),j=f.teamSize(b.teams,b.players),k=b.teams[d],l=f.sortGroup(k,d,b);return _.chain(k.length).apply(g.indices).map(function(d){var e=l[d[0]-1].name,f=l[d[1]-1].name,g=a.suggestTableForTeam(b.rounds,i,e,f);return i=_.without(i,g),c.create(g,e,f,j)}).value()},suggestNextTeamRound:function(b,e){var g=_.flatten(b.teams[e]).length/2,h=_.chain(b.teams).slice(0,e).flatten().value().length/2+1,i=h+b.teams[e].length/2,j=_.range(h,i),k=f.teamSize(b.teams,b.players),l=b.teams[e],m=b.rounds.length-b.bracket[e],n=_.chain(b.teams).slice(0,e).flatten().value().length/2,o=n+l.length/2;return _.chain(b.rounds).last().slice(n,o).chunk(g/(1<<m-1)).reduce(function(e,f){var g=_.chain(f).apply(d.winnerTeams).value(),h=_.chain(f).apply(d.loserTeams).value(),i=_.chain(g).cat(h).chunk(2).value();return _.cat(e,_.map(i,function(d){var e=a.suggestTableForTeam(b.rounds,j,d[0],d[1]);return j=_.without(j,e),c.create(e,d[0],d[1],k)}))},[]).value()},suggestFirstRound:function(a,b){return 0===_.flatten(a.teams).length?g.suggestFirstSingleRound(a,b):g.suggestFirstTeamRound(a,b)},suggestNextRound:function(a,b){return 0===_.flatten(a.teams).length?g.suggestNextSingleRound(a,b):g.suggestNextTeamRound(a,b)},suggestRound:function(a,b,c){var d=a.rounds.length;return c===d?g.suggestFirstRound(a,b):g.suggestNextRound(a,b)}};return g}]).factory("srPairing",["basePairing","rounds","players","teams","game","team_game",function(a,b,c,d,e,f){var g={suggestOpponentFor:function(a,d,e){var f=_.chain(d).groupBy(function(a){return a.points.tournament}).map(function(a){var b=_.filter(a,function(a){return a.city!==e.city}),c=_.filter(a,function(a){return a.city===e.city});return _.cat(c,b)}).flatten().reverse().apply(c.names).value(),g=b.opponentsFor(a,e.name),h=_.difference(f,g);return 0===h.length?c.player(d,f[0]):c.player(d,h[0])},suggestNextSingleRound:function(b,c){var d=_.chain(b.players).slice(0,c).flatten().value().length/2+1,f=d+b.players[c].length/2,h=_.range(d,f),i=b.players[c],j=_.chain(i).groupBy(function(a){return a.points.tournament}).each(function(a,b,c){c[b]=_.shuffle(a)}).flatten().reverse().value();return _.chain(_.range(i.length/2)).map(function(){var c=_.first(j);j=_.rest(j);var d=g.suggestOpponentFor(b.rounds,j,c);j=_.without(j,d);var f=a.suggestTableFor(b.rounds,h,c.name,d.name);return h=_.without(h,f),e.create(f,c.name,d.name)}).sortBy(_.property("table")).value()},suggestOpponentForTeam:function(a,c,e){var f=_.chain(c).groupBy(function(a){return a.points.team_tournament}).map(function(a){var b=_.filter(a,function(a){return a.city!==e.city}),c=_.filter(a,function(a){return a.city===e.city});return _.cat(c,b)}).flatten().reverse().apply(d.names).value(),g=b.opponentsForTeam(a,e.name),h=_.difference(f,g);return 0===h.length?d.team(c,f[0]):d.team(c,h[0])},suggestNextTeamRound:function(b,c){var e=_.chain(b.teams).slice(0,c).flatten().value().length/2+1,h=e+b.teams[c].length/2,i=_.range(e,h),j=b.teams[c],k=d.teamSize(j,b.players),l=_.chain(j).groupBy(function(a){return a.points.team_tournament}).each(function(a,b,c){c[b]=_.shuffle(a)}).flatten().reverse().value();return _.chain(_.range(j.length/2)).map(function(){var c=_.first(l);l=_.rest(l);var d=g.suggestOpponentForTeam(b.rounds,l,c);l=_.without(l,d);var e=a.suggestTableForTeam(b.rounds,i,c.name,d.name);return i=_.without(i,e),f.create(e,c.name,d.name,k)}).sortBy(_.property("table")).value()},suggestRound:function(a,b){return 0===_.flatten(a.teams).length?g.suggestNextSingleRound(a,b):g.suggestNextTeamRound(a,b)}};return g}]).factory("pairing",["bracketPairing","srPairing",function(a,b){var c={suggestRound:function(c,d,e){return _.exists(e)?a.suggestRound(c,d,e):b.suggestRound(c,d)}};return c}]),angular.module("srApp.services").factory("player",[function(){return{is:_.rcurry2(function(a,b){return a.name===b}),create:function(a,b,c,d){return{name:a,faction:b,city:c,team:d,lists:[],points:{tournament:0,sos:0,control:0,army:0}}}}}]).factory("players",["$q","player","factions",function(a,b,c){var d={};a.when(c.baseFactions()).then(function(a){d=a});var e={add:function(a,b,c){return a[c]=_.cat(a[c],b),a},drop:function(a,c){return _.map(a,function(a){return _.reject(a,_.unary(b.is(c.name)))})},player:function(a,c){return _.chain(a).flatten().find(_.unary(b.is(c))).value()},names:function(a){return _.chain(a).flatten().mapWith(_.getPath,"name").value()},factions:function(a){return _.chain(a).flatten().mapWith(_.getPath,"faction").cat(_.keys(d)).uniq().without(void 0).value()},cities:function(a){return _.chain(a).flatten().mapWith(_.getPath,"city").uniq().without(void 0).value()}};return e}]),angular.module("srApp.services").factory("game",[function(){var a={create:function(a,b,c){return{table:a,p1:{name:b,list:null,tournament:null,control:null,army:null},p2:{name:c,list:null,tournament:null,control:null,army:null}}},player:function(a,b){var c=_.getPath(a,"p1.name");return c===b?_.getPath(a,"p1"):_.getPath(a,"p2")},opponentFor:function(a,b){var c=_.getPath(a,"p1.name");return c===b?_.getPath(a,"p2.name"):c},successFor:function(b,c){return _.chain(b).apply(a.player,c).getPath("tournament").value()},listFor:function(b,c){return _.chain(b).apply(a.player,c).getPath("list").value()},tableFor:_.partial(_.getPath,_,"table"),winner:function(a){return 1===a.p1.tournament?a.p1.name:1===a.p2.tournament?a.p2.name:void 0},loser:function(b){return _.chain(b).apply(a.winner).apply(function(c){return a.opponentFor(b,c)}).value()}};return a}]).factory("team_game",["game",function(a){var b={create:function(b,c,d,e){return{table:b,t1:{name:c,team_tournament:null,tournament:null,control:null,army:null},t2:{name:d,team_tournament:null,tournament:null,control:null,army:null},games:_.chain(e).range().map(function(){return a.create(b)}).value()}},team:function(a,b){var c=_.getPath(a,"t1.name");return c===b?_.getPath(a,"t1"):_.getPath(a,"t2")},opponentForTeam:function(a,b){var c=_.getPath(a,"t1.name");return c===b?_.getPath(a,"t2.name"):c},successForTeam:function(a,c){return _.chain(a).apply(b.team,c).getPath("team_tournament").value()},tableForTeam:_.partial(_.getPath,_,"table"),winner:function(a){return 1===a.t1.team_tournament?a.t1.name:1===a.t2.team_tournament?a.t2.name:void 0},loser:function(a){return _.chain(a).apply(b.winner).apply(function(c){return b.opponentForTeam(a,c)}).value()},refreshPoints:function(a){var b=_.chain(a.games).reduce(function(a,b){return{t1:{tournament:a.t1.tournament+(b.p1.tournament||0),control:a.t1.control+(b.p1.control||0),army:a.t1.army+(b.p1.army||0)},t2:{tournament:a.t2.tournament+(b.p2.tournament||0),control:a.t2.control+(b.p2.control||0),army:a.t2.army+(b.p2.army||0)}}},{t1:{tournament:0,control:0,army:0},t2:{tournament:0,control:0,army:0}}).value();_.extend(a.t1,b.t1),_.extend(a.t2,b.t2),a.t1.team_tournament=a.t1.tournament>a.t2.tournament?1:a.t1.tournament<a.t2.tournament?0:null,a.t2.team_tournament=a.t2.tournament>a.t1.tournament?1:a.t2.tournament<a.t1.tournament?0:null}};return b}]).factory("round",["game","team_game",function(a,b){var c={gameFor:function(a,b){return _.isArray(a)&&0!==a.length?_.exists(a[0].games)?_.chain(a).map(function(a){return _.getPath(a,"games")}).map(function(a){return _.find(a,function(a){return a.p1.name===b||a.p2.name===b})}).without(void 0).first().value():_.find(a,function(a){return a.p1.name===b||a.p2.name===b}):[]},gameForTeam:function(a,b){return _.find(a,function(a){return a.t1.name===b||a.t2.name===b})},winners:function(b){return _.map(b,a.winner)},losers:function(b){return _.map(b,a.loser)},winnerTeams:function(a){return _.map(a,b.winner)},loserTeams:function(a){return _.map(a,b.loser)}};return c}]).factory("rounds",["game","team_game","round",function(a,b,c){var d={round:function(a,b){return b>=a.length?[]:a[b]},drop:function(a,b){var c=a.slice();return c.splice(b,1),c},pointsFor:function(b,d,e,f){return _.chain(b).mapWith(c.gameFor,d).map(function(b){return _.exists(b)?b:a.create(0,d)}).mapWith(a.player,d).reduce(function(a,b,c){var d=f>>c-e;return{bracket:_.exists(e)&&c>=e?a.bracket+d*b.tournament:a.bracket,tournament:a.tournament+b.tournament,control:a.control+b.control,army:a.army+b.army}},{bracket:0,tournament:0,control:0,army:0}).spy("pointsFor",d).value()},pointsForTeam:function(a,d,e,f){return _.chain(a).mapWith(c.gameForTeam,d).without(void 0).mapWith(b.team,d).reduce(function(a,b,c){var d=f>>c-e;return{bracket:_.exists(e)&&c>=e?a.bracket+d*b.team_tournament:a.bracket,team_tournament:a.team_tournament+b.team_tournament,tournament:a.tournament+b.tournament,control:a.control+b.control,army:a.army+b.army}},{bracket:0,team_tournament:0,tournament:0,control:0,army:0}).spy("pointsForTeam",d).value()},opponentsFor:function(b,d){return _.chain(b).mapWith(c.gameFor,d).without(void 0).mapWith(a.opponentFor,d).without(void 0).value()},opponentsForTeam:function(a,d){return _.chain(a).mapWith(c.gameForTeam,d).without(void 0).mapWith(b.opponentForTeam,d).without(void 0).value()},tablesFor:function(b,d){return _.chain(b).mapWith(c.gameFor,d).mapWith(a.tableFor,d).value()},listsFor:function(b,d){return _.chain(b).mapWith(c.gameFor,d).mapWith(a.listFor,d).uniq().without(void 0,null).value()},tablesForTeam:function(a,d){return _.chain(a).mapWith(c.gameForTeam,d).mapWith(b.tableForTeam,d).value()},gameFor:function(a,b,e){return _.chain(a).apply(d.round,e).apply(c.gameFor,b).value()},gameForTeam:function(a,b,e){return _.chain(a).apply(d.round,e).apply(c.gameForTeam,b).value()},query:function(b,e,f,g){return _.chain(b).apply(d.round,e).apply(c.gameFor,f).apply(a[g],f).value()},teamQuery:function(a,e,f,g){return _.chain(a).apply(d.round,e).apply(c.gameForTeam,f).apply(b[g],f).value()}};return d}]),angular.module("srApp.services").factory("state",["$window","player",function(a,b){var c={init:function(){return c.create()},test:function(a){var c=_.clone(a),d=["Faction1","Faction2","Faction3","Faction4"],e=["City1","City2","City3","City4"],f=["Team1","Team2","Team3","Team4"];return c.players=[[],[]],_.range(8).map(function(a){c.players[a>>2].push(b.create("Player"+(a+1),_.chain(d).shuffle().first().value(),_.chain(f).shuffle().first().value(),_.chain(e).shuffle().first().value())),c.players[a>>2][a%4].lists.push({caster:"Caster1"},{caster:"Caster2"})}),c},create:function(a){var b=_.clone(a||{});return _.defaults(b,{players:[[]]})},hasPlayers:function(a){return 0!==_.flatten(a.players).length},hasPlayerGroups:function(a){return a.players.length>1},isTeamTournament:function(a){return 0!==_.flatten(a.teams).length}};return c}]),angular.module("srApp.services").factory("t3",["factions","player",function(a,b){var c={};return a.baseFactions().then(function(a){_.each(a,function(a){c[a.t3]=a.name})}),{parse:function(a){return _.chain(a).apply(function(a){return a.split("\n")}).rest().map(function(a){return a.split(";")}).filter(function(a){return 10===a.length&&a[3].length>0}).map(function(a){var b={name:a[3],city:a[5]};return _.each(c,function(c,d){a[4].indexOf(d)>-1&&(b.faction=c)}),b}).map(function(a){return b.create(a.name,a.faction,a.city)}).value()}}}]).factory("t3Import",["$window","$q","t3",function(a,b,c){return{read:function(d){var e=new a.FileReader,f=b.defer();return e.onload=function(a){var b;try{b=c.parse(a.target.result),f.resolve(b)}catch(d){f.reject("invalid file")}},e.onerror=function(){f.reject("error reading file")},e.onabort=function(){f.reject("abort reading file")},e.readAsText(d),f.promise}}}]),angular.module("srApp.services").factory("team",[function(){return{is:_.rcurry2(function(a,b){return a.name===b}),rank:function(a,b){var c=b(a.points.team_tournament,a.points.tournament,a.points.sos,a.points.control,a.points.army);return c},create:function(a,b){return{name:a,city:b,points:{team_tournament:0,tournament:0,sos:0,control:0,army:0}}
}}}]).factory("teams",["team","players","factions",function(a,b,c){var d={};c.baseFactions().then(function(a){d=a});var e={add:function(a,b,c){return a[c]=_.cat(a[c],b),a},drop:function(b,c){return _.map(b,function(b){return _.reject(b,_.unary(a.is(c.name)))})},team:function(b,c){return _.chain(b).flatten().find(_.unary(a.is(c))).value()},names:function(a){return _.chain(a).flatten().mapWith(_.getPath,"name").value()},cities:function(a){return _.chain(a).flatten().mapWith(_.getPath,"city").uniq().without(void 0).value()},factions:function(a){return _.chain(a).flatten().mapWith(_.getPath,"faction").cat(_.keys(d)).uniq().without(void 0).value()},sortGroup:function(c,d,e){if(_.exists(e.bracket[d]))return _.sortBy(c.slice(),function(a){return-a.points.bracket});var f=new Function("ttp","tp","sos","cp","ap","team_size","n_teams","n_players","n_rounds","return "+e.ranking.team+";"),g=_.chain(e.teams).flatten().map(function(a){return b.inTeam(e.players,a.name).length}).max().value(),h=_.flatten(e.teams).length,i=_.flatten(e.players).length,j=_.partial(f,_,_,_,_,_,g,h,i,e.rounds.length);return _.sortBy(c.slice(),function(b){return-a.rank(b,j)})},sort:function(a,b){return _.map(a,function(a,c){return e.sortGroup(a,c,b)})},sosFrom:function(a,b){return _.chain(b).map(_.partial(e.team,a)).reduce(function(a,b){return a+_.getPath(b,"points.team_tournament")},0).value()},teamSize:function(a,c){return _.chain(a).flatten().map(function(a){return b.inTeam(c,a.name).length}).max().value()},chunk:function(a,b){return _.chain(a).flatten().chunkAll(b).value()}};return e}]);