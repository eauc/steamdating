"use strict";angular.module("srApp.services",[]),angular.module("srApp.filters",[]),angular.module("srApp.controllers",[]),angular.module("srApp.directives",[]),angular.module("srApp",["ui.router","srApp.controllers","srApp.filters","srApp.services","srApp.directives"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/players"),a.state("file",{url:"/file",templateUrl:"partials/file.html",controller:"fileCtrl",data:{}}).state("players",{url:"/players",templateUrl:"partials/players.html",controller:"playersCtrl",data:{}}).state("groups_edit",{url:"/groups_edit",templateUrl:"partials/groups_edit.html",controller:"groupEditCtrl",data:{}}).state("player_edit",{templateUrl:"partials/player_edit.html",controller:"playerEditCtrl",data:{}}).state("rounds",{url:"/rounds",templateUrl:"partials/rounds.html",controller:"roundsCtrl",data:{}}).state("rounds.sum",{url:"/sum",templateUrl:"partials/rounds_sum.html",controller:"roundsSumCtrl",data:{}}).state("rounds.next",{url:"/next",templateUrl:"partials/rounds_next.html",controller:"roundsNextCtrl",data:{}}).state("rounds.nth",{url:"/:pane",templateUrl:"partials/rounds_nth.html",controller:"roundsNthCtrl",data:{}}).state("game_edit",{templateUrl:"partials/game_edit.html",controller:"gameEditCtrl",data:{}}).state("ranking_edit",{url:"/ranking_edit",templateUrl:"partials/ranking_edit.html",controller:"rankingEditCtrl",data:{}}).state("stats",{url:"/stats",templateUrl:"partials/stats.html",controller:"statsCtrl",data:{}})}]).config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob):/)}]),angular.module("srApp.controllers").controller("fileCtrl",["$scope","$q","prompt","state","fileExport","fileImport","factions",function(a,b,c,d,e,f,g){a.$on("$destroy",function(){_.each(a.exports,function(a){e.cleanup(a.url)})}),a.updateExports=function(){var b=(new Date).getTime();a.save={name:"steamdating_"+b+".json",url:e.generate("json",a.state)},a.exports={fk:{name:"players_"+b+".txt",url:e.generate("fk",a.state.players),label:"FK players list"},csv_rank:{name:"ranking_"+b+".csv",url:e.generate("csv",d.rankingTables(a.state)),label:"CSV Ranking"},bb_rank:{name:"ranking_"+b+".txt",url:e.generate("bb",d.rankingTables(a.state)),label:"BB Ranking"}}},a.updateExports(),a.factions={},b.when(g.baseFactions()).then(function(b){a.factions=b}),a.doReset=function(){return d.isEmpty(a.state)?void a.resetState():void c.prompt("confirm","You sure ?").then(function(){a.resetState()})},a.doOpenFile=function(b){f.read("json",b,a.factions).then(function(b){var c=b[0],d=b[1];a.resetState(c),a.open_result=d,a.goToState("players")},function(b){a.open_result=b})},a.doImportFile=function(b,c){f.read(b,c,a.factions).then(function(c){var d=c[0],e=c[1];a.resetState({players:[d]}),a["import_"+b+"_result"]=e,_.isEmpty(e)?a.goToState("players"):(a["import_"+b+"_result"].push(d.length+" players have been read successfully"),a.updateExports())},function(c){a["import_"+b+"_result"]=c})}}]),angular.module("srApp.controllers").controller("gameEditCtrl",["$scope","players","lists",function(a,b,c){a.game=_.snapshot(a.edit.game),a.setWinLoss=function(a,b,c){a[b].tournament=1,a[c].tournament=0},a.close=function(b){b&&(_.extend(a.edit.game,a.game),a.updatePoints(),a.storeState()),a.goToState("rounds."+a.edit.back,{pane:a.edit.pane})},a.casters={},a.casters[a.game.p1.name]=_.chain(a.state.players).apply(b.player,a.game.p1.name).apply(_.getPath,"lists").apply(c.casters).value(),a.casters[a.game.p2.name]=_.chain(a.state.players).apply(b.player,a.game.p2.name).apply(_.getPath,"lists").apply(c.casters).value()}]),angular.module("srApp.controllers").controller("groupEditCtrl",["$scope","prompt","players","state",function(a,b,c,d){a.new_state=_.clone(a.state),a.new_state.players=_.chain(a.state).apply(d.sortPlayers).map(function(a){return _.chain(a).mapWith(_.getPath,"players").flatten().value()}).value(),a.selection={},a.isSelectionEmpty=function(){return!_.chain(a.selection).values().any().value()},a.chunkGroups=function(){b.prompt("prompt","Groups size").then(function(b){var e=parseFloat(b);_.isNaN(e)||(a.new_state.players=c.chunkGroups(a.new_state.players,parseFloat(e)),a.new_state.bracket=d.clearBracket(a.new_state))})},a.splitSelection=function(){var b=_.reduce(a.selection,function(a,b,c){return b?_.cat(a,c):a},[]);a.new_state.players=c.splitNewGroup(a.new_state.players,b),a.new_state.bracket=d.clearBracket(a.new_state)},a.moveSelectionFront=function(){var b=_.reduce(a.selection,function(a,b,c){return b?_.cat(a,c):a},[]);_.each(b,function(b){a.new_state.players=c.movePlayerGroupFront(a.new_state.players,b)}),a.new_state.bracket=d.clearBracket(a.new_state)},a.moveSelectionBack=function(){var b=_.reduce(a.selection,function(a,b,c){return b?_.cat(a,c):a},[]);_.each(b,function(b){a.new_state.players=c.movePlayerGroupBack(a.new_state.players,b)}),a.new_state.bracket=d.clearBracket(a.new_state)},a.moveGroupFront=function(b){a.new_state.players=c.moveGroupFront(a.new_state.players,b),a.new_state.bracket=d.clearBracket(a.new_state)},a.moveGroupBack=function(b){a.new_state.players=c.moveGroupBack(a.new_state.players,b),a.new_state.bracket=d.clearBracket(a.new_state)},a.doClose=function(b){b&&(a.state.players=a.new_state.players,a.state.bracket=a.new_state.bracket,a.updatePoints(),a.storeState()),a.goToState("players")}}]),angular.module("srApp.controllers").controller("mainCtrl",["$scope","$state","$q","factions","state","players",function(a,b,c,d,e){d.init(),a.resetState=function(b){a.state=e.create(b)},a.state=e.init(),a.goToState=_.bind(b.go,b),a.currentState=_.bind(_.getPath,_,b,"current.name"),a.stateIs=_.bind(b.is,b),a.edit={},a.doEditPlayer=function(b){a.edit.player=b,a.goToState("player_edit")},a.updatePoints=function(){a.state.players=e.updatePlayersPoints(a.state)},a.storeState=function(){e.store(a.state)}}]),angular.module("srApp.controllers").controller("playersCtrl",["$scope","prompt","state","players","player",function(a,b,c,d,e){a.doAddPlayer=function(b){a.edit.player=e.create(),a.edit.group=b,a.goToState("player_edit")},a.doDropPlayer=function(e,f){b.prompt("confirm","You sure ?").then(function(){a.state.players=d.drop(a.state.players,e),c.store(a.state),a.sorted_players=c.sortPlayers(a.state)}),f.stopPropagation()},a.sorted_players=c.sortPlayers(a.state)}]).controller("playerEditCtrl",["$scope","$q","prompt","factions","state","players","list","lists",function(a,b,c,d,e,f,g,h){a.player=_.clone(a.edit.player),b.when(d.baseFactions()).then(function(b){a.factions=f.factions(a.state.players,b)}),a.cities=f.cities(a.state.players),a.doClose=function(b){if(b){if(!_.isString(a.player.name)||0>=a.player.name)return void c.prompt("alert","invalid player name");var d=f.names(a.state.players);if(_.exists(a.edit.player.name)&&(d=_.without(d,a.edit.player.name)),0<=_.indexOf(d,a.player.name))return void c.prompt("alert","a player with the same name already exists");_.exists(a.edit.player.name)?_.extend(a.edit.player,a.player):a.state.players=f.add(a.state.players,a.player,a.edit.group),a.storeState()}a.goToState("players")},a.list=0===a.player.lists.length?-1:0,a.doSwitchToList=function(b){a.list=b},a.doAddList=function(){a.list=a.player.lists.length,a.player.lists=h.add(a.player.lists,g.create(a.player.faction))},a.doDropList=function(b){a.player.lists=h.drop(a.player.lists,b)}}]),angular.module("srApp.controllers").controller("rankingEditCtrl",["$scope","prompt","ranking","player",function(a,b,c,d){function e(){a.player_ranking_valid=!0;var b=c.buildPlayerCritFunction(a.player_test.ranking,a.player_test.n_rounds,a.player_test.n_players);return _.isFunction(b)?(a.player_test.player1.rank=d.rank(a.player_test.player1,b),_.isNumber(a.player_test.player1.rank)||(a.player_ranking_valid=!1),a.player_test.player2.rank=d.rank(a.player_test.player2,b),void(_.isNumber(a.player_test.player2.rank)||(a.player_ranking_valid=!1))):(a.player_test.player1.rank=b,a.player_test.player2.rank=b,void(a.player_ranking_valid=!1))}a.pane="player",a.player_test={ranking:a.state.ranking.player,n_rounds:5,n_players:32,player1:{name:"p1",points:{tournament:4,sos:10,control:13,army:38},rank:0},player2:{name:"p2",points:{tournament:3,sos:15,control:8,army:45},rank:0}},a.$watch("player_test",e,!0),a.doReset=function(b){"player"===b&&(a.player_test.ranking=c.srPlayerCrit())},a.doClose=function(c){if(c){if(!a.player_ranking_valid)return b.prompt("alert","current player ranking is invalid !"),void(a.pane="player");a.state.ranking.player=a.player_test.ranking,a.storeState()}a.goToState("players")}}]),angular.module("srApp.controllers").controller("roundsCtrl",["$scope","round",function(a,b){a.round={},a.doGameEdit=function(c,d,e,f){a.edit.game=b.gameForPlayer(c,d),a.edit.back=e,a.edit.pane=f,a.goToState("game_edit")}}]).controller("roundsSumCtrl",["$scope","players",function(a,b){a.state.players=b.updateListsPlayed(a.state.players,a.state.rounds)}]).controller("roundsNextCtrl",["$scope","state","round","rounds","srPairing","bracketPairing",function(a,b,c,d,e,f){a.new_state=_.clone(a.state),a.next_round=d.createNextRound(a.state.players),a.updatePlayersOptions=function(){a.players_options=_.map(a.new_state.players,function(b,d){return _.map(b,function(b){var e=c.isPlayerPaired(a.next_round[d],b),f=e?b.name:"> "+b.name;return[b.name,f]})}),a.pairs_already=_.map(a.next_round,function(b){return _.map(b,function(b){return d.pairAlreadyExists(a.new_state.rounds,b)})})},a.updatePlayersOptions(),a.suggestNextRound=function(c,d){"bracket"===d&&(a.new_state.bracket=b.setBracket(a.new_state,c),a.next_round[c]=f.suggestRound(a.new_state,c)),"sr"===d&&(a.new_state.bracket=b.resetBracket(a.new_state,c),a.next_round[c]=e.suggestNextRound(a.new_state,c)),a.updatePlayersOptions()},a.registerNextRound=function(){a.state.bracket=a.new_state.bracket,a.state.rounds=d.registerNextRound(a.new_state.rounds,a.next_round),a.storeState(),a.goToState("rounds.nth",{pane:a.state.rounds.length-1})},a.updateNextRound=function(b,d,e){a.next_round[b]=c.updatePlayer(a.next_round[b],d,e),a.updatePlayersOptions()}}]).controller("roundsNthCtrl",["$scope","$stateParams","prompt","rounds",function(a,b,c,d){a.round.current=b.pane,a.r=a.state.rounds[b.pane],_.exists(a.r)||a.goToState("rounds.sum"),a.doDeleteRound=function(b){c.prompt("confirm","You sure ?").then(function(){a.state.rounds=d.drop(a.state.rounds,parseFloat(b)),a.updatePoints(),a.storeState(),a.goToState("rounds.sum")})}}]),angular.module("srApp.controllers").controller("statsCtrl",["$scope","$q","factions","players","stats",function(a,b,c,d,e){a.factions=d.factions(a.state.players),a.players=d.names(a.state.players),a.casters=d.casters(a.state.players),a.stats={};a.getStats=function(){var b=a.selection[a.selection.type],c=e.get(a.state,a.selection.type,b,a.selection.group_by,a.stats);return _.indexOf(_.mapWith(c,_.first),a.group)<0&&(a.group=c[0][0]),c},a.selection={type:"faction",group_by:"total",faction:a.factions[0],player:a.players[0],caster:a.casters[0].name},a.setGroup=function(b){a.group=b}}]),angular.module("srApp.controllers").controller("teamEditCtrl",["$scope","players","player","factions","$window","teams",function(a,b,c,d,e,f){a.state.factions=b.factions(a.state.players),a.state.cities=f.cities(a.state.teams),a.team=_.snapshot(a.edit.team),a.doClose=function(b){if(b){if(!_.isString(a.team.name)||0>=a.team.name)return void e.alert("invalid team info");var c=f.names(a.state.teams);if(_.exists(a.edit.team.name)&&(c=_.without(c,a.edit.team.name)),0<=_.indexOf(c,a.team.name))return void e.alert("a team with the same name already exists");_.exists(a.edit.team.name)?_.extend(a.edit.team,a.team):a.state.teams=f.add(a.state.teams,a.team,a.edit.group),a.storeState()}a.goToState("players")}}]),angular.module("srApp.directives").factory("appCache",["$window","$rootScope",function(a){function b(a){var b="progress"===a.type;c.progress=b?(c.progress+1)%100:0,c.onProgress(b)}var c={progress:0,onProgress:function(){},onUpdateReady:function(){}},d=a.applicationCache;return d.addEventListener("cached",b,!1),d.addEventListener("checking",b,!1),d.addEventListener("downloading",b,!1),d.addEventListener("error",b,!1),d.addEventListener("noupdate",b,!1),d.addEventListener("obsolete",b,!1),d.addEventListener("progress",b,!1),d.addEventListener("updateready",function(a){d.status===d.UPDATEREADY&&c.onUpdateReady(),c.progress=0,c.onProgress(!1)},!1),c}]).directive("appCacheProgressBar",function(){return{restrict:"E",template:'<div class="appcache-progress"     ng-show="appCache.progress != 0">  <div class="appcache-progress-bar"       ng-style="{\'width\': appCache.progress + \'%\' }"></div></div>',controller:["$scope","$window","prompt","appCache",function(a,b,c,d){a.appCache=d,d.onProgress=function(){a.$digest()},d.onUpdateReady=function(){c.prompt("confirm","A new version of this site is available. Load it?").then(function(){b.location.reload()})}}],link:function(){}}}),angular.module("srApp.directives").directive("autofocus",function(){return{restrict:"A",link:function(a,b){b[0].focus()}}}),angular.module("srApp.directives").controller("barsCtrl",["$scope",function(a){a.$watch("values",function(b){if(!_.exists(b))return void(a.bars=[]);var c=Math.max.apply(null,_.values(b)),d=30/Math.max(1,_.keys(b).length-1);a.bars=_.chain(b).map(function(b,d){return{k:d,name:s.capitalize(d),width:a.width*b/c,value:b}}).apply(function(a){return a.sort(function(a,b){return a.value<b.value?1:b.value<a.value?-1:a.name.localeCompare(b.name)})}).map(function(b,c){return b.color=_.exists(_.getPath(a.hues,b.k))?"hsl("+_.getPath(a.hues,b.k)[0]+", "+_.getPath(a.hues,b.k)[1]+"%, 52%)":"hsl("+a.hue+", "+a.saturation+"%, "+(35+c*d)+"%)",b}).value()})}]).directive("bars",[function(){return{restrict:"E",templateUrl:"partials/directives/bars.html",scope:{values:"=barsValues",hues:"=barsHues"},controller:"barsCtrl",link:function(a,b,c){a.width=.7*(b[0].querySelector("table").offsetWidth>>0),a.height=50,a.hue="200",c.$observe("barsHue",function(b){a.hue=_.exists(b)?b:"200"}),a.saturation="75",c.$observe("barsSaturation",function(b){a.saturation=_.exists(b)?b:"75"})}}}]),angular.module("srApp.directives").directive("eaFile",function(){return{restrict:"A",scope:{eaFile:"&"},controller:["$scope",function(){}],link:function(a,b){b[0].onchange=function(){a.eaFile({file:b[0].files[0]})}}}}),angular.module("srApp.directives").factory("prompt",["$q",function(a){function b(){if(_.exists(c))return c;var b=a.defer();return e.push(b),b.promise}var c,d,e=[];return{register:function(a){c=a,c.active=!1,c.message=null,c.type="alert",c.input=null,c.doValidate=function(){c.close(),d.resolve(c.input),d=null},c.doCancel=function(){c.close(),d.reject(),d=null},_.each(e,function(a){a.resolve(c)}),e=[]},prompt:function(c,e){return d=a.defer(),a.when(b()).then(function(a){a.type=c,a.message=_.isString(e)?[e]:e,a.input=null,a.open()}),d.promise}}}]).controller("promptCtrl",["$scope","prompt",function(a,b){b.register(a)}]).directive("prompt",["$timeout",function(a){return{restrict:"E",templateUrl:"partials/directives/prompt.html",scope:!0,controller:"promptCtrl",link:function(b,c){var d=c[0].querySelector("input");b.open=function(){b.active=!0,a(function(){d.focus()},200)},b.close=function(){b.active=!1}}}}]),angular.module("srApp.directives").controller("stacksCtrl",["$scope",function(a){a.$watch("values",function(b){if(!_.exists(b))return void(a.stacks=[]);var c=_.reduce(b.values,function(a,b,c){return a[c]=_.reduce(b,function(a,b){return a+b},0),a},{});a.stacks=_.map(b.values,function(d,e){var f=0;return{name:e,layers:_.map(d,function(g,h){var i=0<c[e]?a.width*g/c[e]:a.width/d.length,j={x:f,width:i,color:b.colors[h],value:g};return f+=i,j})}})})}]).directive("stacks",[function(){return{restrict:"E",templateUrl:"partials/directives/stacks.html",scope:{values:"=stacksValues"},controller:"stacksCtrl",link:function(a,b){a.width=.7*(b[0].querySelector("table").offsetWidth>>0),a.height=50}}}]),angular.module("srApp.filters").filter("factions",["factions",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]),angular.module("srApp.filters").filter("player",["player",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]).filter("players",["players",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]),angular.module("srApp.filters").filter("game",["game",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]).filter("rounds",["rounds",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]).filter("round",["round",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]),angular.module("srApp.filters").filter("state",["state",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]),angular.module("srApp.filters").filter("teams",["teams",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]),_.mixin({apply:function(a,b){var c=_.rest(_.rest(arguments));return b.apply(null,_.cons(a,c))}}),_.mixin({mapWith:function(a,b){var c=_.rest(_.rest(arguments)),d=_.partial.apply(null,_.cat([b,_],c));return _.map(a,d)}}),_.mixin({spy:function(a){var b=_.rest(arguments);return console.log.apply(console,_.cat(b,[a])),a}}),angular.module("srApp.services").factory("backup",["$window","$q",function(a,b){return a.URL=a.URL||a.webkitURL,{read:function(c){var d=new a.FileReader,e=b.defer();return d.onload=function(a){var b;try{b=JSON.parse(a.target.result),e.resolve(b)}catch(c){e.reject("invalid file")}},d.onerror=function(){e.reject("error reading file")},d.onabort=function(){e.reject("abort reading file")},d.readAsText(c),e.promise},generate:function(b){return _.chain(b).apply(JSON.stringify).apply(function(b){return new a.Blob([b],{type:"text/plain"})}).apply(a.URL.createObjectURL).value()},cleanup:function(b){null!==b&&a.URL.revokeObjectURL(b)}}}]),angular.module("srApp.services").factory("bbStringifier",[function(){function a(a,b){return"["+b+"]"+a+"[/"+b+"]"}var b="\r\n",c={stringify:function(c){return _.chain(c).map(function(c,d){var e=_.chain(c).map(function(b,c){return _.chain(b).map(function(b){return 0===c?a(b,"b"):b}).mapWith(a,"td").join("").apply(a,"tr").value()}).join(b).apply(a,"table").value();return _.cat(["",a("Group "+(d+1),"b")],e)}).flatten().join(b).value()}};return c}]),angular.module("srApp.services").factory("csvStringifier",[function(){var a="\r\n",b={stringify:function(b){return _.chain(b).map(function(a,b){return _.cat(["","Group "+(b+1)],_.map(a,function(a){return a.join(",")}))}).flatten().join(a).value()}};return b}]),angular.module("srApp.services").factory("factions",["$window","$http","$q",function(a,b,c){var d,e=[];return{init:function(){b.get("data/factions.json").then(function(a){d=a.data,_.each(e,function(a){a.resolve(d)})},function(a){})},baseFactions:function(){if(_.exists(d))return d;var a=c.defer();return e.push(a),a.promise},iconFor:function(a){return _.chain(a).apply(function(a){var b=d||{};return _.exists(b[a])?b[a].icon:void 0}).apply(function(a){return _.exists(a)?"data/icons/"+a:""}).value()},hueFor:function(a){return _.chain(a).apply(function(a){var b=d||{};return _.exists(b[a])?b[a].hue:void 0}).value()},castersFor:function(a){return _.chain(a).apply(function(a){var b=d||{};return _.exists(b[a])?b[a].casters:void 0}).value()},casterNameFor:function(a,b){return _.chain(a).apply(function(a){var b=d||{};return _.exists(b[a])?b[a].casters:void 0}).apply(_.getPath,b+".name").value()}}}]),angular.module("srApp.services").factory("jsonStringifier",[function(){var a={stringify:function(a){return JSON.stringify(a,function(a,b){return s.startsWith(a,"$$")?void 0:b})}};return a}]).factory("fileExport",["$window","fkStringifier","csvStringifier","bbStringifier","jsonStringifier",function(a,b,c,d,e){a.URL=a.URL||a.webkitURL;var f={fk:b,csv:c,bb:d,json:e};return{generate:function(b,c){return _.chain(c).apply(f[b].stringify).apply(function(b){return new a.Blob([b],{type:"text/plain"})}).apply(a.URL.createObjectURL).value()},cleanup:function(b){_.exists(b)&&a.URL.revokeObjectURL(b)}}}]),angular.module("srApp.services").factory("fileImport",["$window","$q","t3Parser","fkParser",function(a,b,c,d){var e={t3:c,fk:d,json:{parse:function(a){return[JSON.parse(a),[]]}}};return{read:function(c,d,f){var g=new a.FileReader,h=b.defer();return g.onload=function(a){var b;try{b=e[c].parse(a.target.result,f),h.resolve(b)}catch(d){h.reject(["invalid file : "+d.message])}},g.onerror=function(){h.reject(["error reading file"])},g.onabort=function(){h.reject(["abort reading file"])},g.readAsText(d),h.promise}}}]),angular.module("srApp.services").factory("fkParser",["player","list","lists",function(a,b,c){function d(a){return s.include(a,":")}var e={onParam:function(a,b,c){a.error.push("line "+a.nline+' parameter "'+b+'"="'+s.truncate(c,8)+'" ignored')},onSeparator:function(){},onLine:function(a,b){a.error.push("line "+a.nline+" ignored : "+s.truncate(b,15))}},f=_.defaults({onParam:function(){},onSeparator:function(a){a.state=g},onLine:function(){}},e),g=_.defaults({onParam:function(a,b,c){switch(b){case"Player":return s.isBlank(c)?(a.error.push("line "+a.nline+" empty player name"),a.player=null,void(a.state=f)):0<=_.indexOf(a.players,c)?(a.error.push("line "+a.nline+' player name "'+c+'" already exists'),a.player=null,void(a.state=f)):(a.players.push(c),a.player={name:c},void(a.state=h));case"System":return _.exists(a.player)?(a.list={content:[],faction:a.player.faction},void(a.state=i)):(a.error.push("line "+a.nline+" unexpected list definition"),void(a.state=f));default:e.onParam(a,b,c)}}},e),h=_.defaults({onParam:function(a,b,c){switch(b){case"Faction":return 0>_.indexOf(_.keys(a.factions),c)&&a.error.push("line "+a.nline+' unknown faction "'+c+'"'),void(a.player.faction=c);case"City":return void(a.player.city=c);default:e.onParam(a,b,c)}},onSeparator:function(b){b.res.push(a.create(b.player.name,b.player.faction,b.player.city)),b.state=g}},e),i=_.defaults({onParam:function(a,b,c){switch(b){case"Faction":return void(a.list.theme=c===a.list.faction?null:c);case"Casters":case"Points":case"Tiers":break;default:e.onParam(a,b,c)}},onSeparator:function(a){var d=b.create(a.list.faction,a.list.caster,a.list.theme,a.list.content.join("\n")),e=_.last(a.res);e.lists=c.add(e.lists,d),a.state=g},onLine:function(a,b){var c=_.chain(a.factions).getPath(a.list.faction).getPath("casters").reduce(function(a,c,d){return _.exists(a)?a:s.startsWith(b,c.name)?d:null},null).value();_.exists(c)||(c=b.replace(/\(.*\)/,""),a.error.push("line "+a.nline+' unknown caster "'+c+'"')),a.list.caster=c,a.list.content.push(b),a.state=j}},e),j=_.defaults({onSeparator:i.onSeparator,onLine:function(a,b){a.list.content.push(b)}},e);return{parse:function(a,b){var c={factions:b,state:g,res:[],error:[],players:[]};return _.chain(a).apply(s.lines).cat("").each(function(a,b){return c.nline=b+1,d(a)?c.state.onParam(c,s(a).strLeft(":").trim().value(),s(a).strRight(":").trim().value()):s.isBlank(a)?c.state.onSeparator(c):c.state.onLine(c,s.trim(a))}).value(),[c.res,c.error]}}}]),angular.module("srApp.services").factory("fkStringifier",[function(){var a="\r\n",b={stringify:function(b){return _.chain(b).flatten().map(function(b){var c=["Player: "+b.name];return _.exists(b.city)&&c.push("City: "+b.city),_.exists(b.faction)&&c.push("Faction: "+b.faction),b.lists.length>0&&(c.push(""),_.each(b.lists,function(a){c.push("System: Warmachordes"),c.push("Faction: "+(_.exists(a.theme)?a.theme:a.faction)),c.push(a.fk),c.push("")})),c.join(a)+a}).join(a).value()}};return b}]),angular.module("srApp.services").factory("game",[function(){var a={create:function(a,b,c){return{table:a,p1:{name:b,list:null,tournament:null,control:null,army:null},p2:{name:c,list:null,tournament:null,control:null,army:null},games:[]}},forPlayer:function(b,c){if(c===b.p1.name||c===b.p2.name)return b;if(0!==b.games.length)return _.chain(b.games).filter(_.partial(a.forPlayer,_,c)).first().value()},player:function(a,b){var c=_.getPath(a,"p1.name");return c===b?_.getPath(a,"p1"):_.getPath(a,"p2")},opponentForPlayer:function(a,b){var c=_.getPath(a,"p1.name");return c===b?_.getPath(a,"p2.name"):c},winForPlayer:function(b,c){var d=_.chain(b).apply(a.player,c).getPath("tournament").value();return 1===d?!0:0===d?!1:void 0},listForPlayer:function(b,c){return _.chain(b).apply(a.player,c).getPath("list").value()},tableForPlayer:_.partial(_.getPath,_,"table"),isValid:function(a){return _.isString(a.p1.name)&&_.isString(a.p2.name)},winner:function(a){return 1===a.p1.tournament?a.p1.name:1===a.p2.tournament?a.p2.name:void 0},loser:function(b){return _.chain(b).apply(a.winner).apply(function(c){return _.exists(c)?a.opponentForPlayer(b,c):void 0}).value()}};return a}]).factory("games",["game",function(a){var b={pointsForPlayer:function(c,d,e,f){return _.chain(c).mapWith(a.player,d).apply(b.reducePoints,e,f).value()},pointsAgainstPlayer:function(c,d,e,f){return _.chain(c).map(function(b){return a.player(b,a.opponentForPlayer(b,d))}).apply(b.reducePoints,e,f).value()},reducePoints:function(a,b,c){return _.chain(a).reduce(function(a,d,e){var f=c>>e-b;return{bracket:_.exists(b)&&e>=b?a.bracket+f*d.tournament:a.bracket,tournament:a.tournament+d.tournament,control:a.control+d.control,army:a.army+d.army,sos:0}},{bracket:0,tournament:0,control:0,army:0,sos:0}).value()},opponentsForPlayer:function(b,c){return _.chain(b).mapWith(a.opponentForPlayer,c).without(void 0).value()},listsForPlayer:function(b,c){return _.chain(b).mapWith(a.listForPlayer,c).uniq().without(void 0,null).value()},tablesForPlayer:function(b,c){return _.chain(b).mapWith(a.tableForPlayer,c).without(void 0,null).value()},forCaster:function(b,c,d){return _.filter(b,function(b){return _.chain(b).apply(a.player,c).getPath("list").value()===d})}};return b}]),angular.module("srApp.services").factory("list",[function(){return{create:function(a,b,c,d){return{faction:a,caster:b,theme:c,fk:d}},references:function(a){return _.chain(a).getPath("fk").apply(s.lines).filter(_.complement(s.isBlank)).map(function(a){return a.replace(/\(.*\)/,"")}).map(function(a){return a.replace(/\*/,"")}).map(function(a){return a.replace(/\d+/,"")}).map(function(a){return s.trim(a)}).value()}}}]).factory("lists",["list",function(){var a={add:function(a,b){return _.cat(a,b)},drop:function(a,b){var c=a.slice();return c.splice(b,1),c},casters:function(a){return _.mapWith(a,_.getPath,"caster")},listForCaster:function(a,b){return _.chain(a).filter(function(a){return a.caster===b}).first().value()},themeForCaster:function(a,b){return _.chain(a).filter(function(a){return a.caster===b}).first().getPath("theme").value()},containsCaster:function(a,b){return _.chain(a).findWhere({caster:b}).exists().value()}};return a}]),angular.module("srApp.services").factory("basePairing",["rounds","players",function(a,b){var c={tableRangeForGroup:function(a,c){var d=b.indexRangeForGroup(a,c);return _.range(Math.round(d[0]/2+1),Math.round(d[1]/2+1))},suggestTableFor:function(b,c,d,e){var f=a.tablesForPlayer(b,d),g=a.tablesForPlayer(b,e),h=_.difference(c,f,g);return 0===h.length?c[0]:h[0]}};return c}]).factory("bracketPairing",["basePairing","players","game","round","state",function(a,b,c,d,e){var f={indices:function(a){return 2===a?[[1,2]]:_.chain(f.indices(a/2)).map(function(b){return[[b[0],a+1-b[0]],[a+1-b[1],b[1]]]}).reduce(function(a,b){return _.cat(a,b)},[]).value()},suggestFirstSingleRound:function(d,e){var g=a.tableRangeForGroup(d.players,e),h=d.players[e],i=_.chain(h).apply(b.sortGroup,d,!1).mapWith(_.getPath,"players").flatten().value();return _.chain(i.length).apply(f.indices).map(function(b){var e=i[b[0]-1].name,f=i[b[1]-1].name,h=a.suggestTableFor(d.rounds,g,e,f);return g=_.without(g,h),c.create(h,e,f)}).value()},suggestNextSingleRound:function(b,f){var g=a.tableRangeForGroup(b.players,f),h=e.bracketNbRounds(b,f);return _.chain(b.rounds).last().apply(d.gamesForGroup,b.players,f).chunk(b.players[f].length/(1<<h)).reduce(function(e,f){var h=_.chain(f).apply(d.winners).value(),i=_.chain(f).apply(d.losers).value(),j=_.chain(h).cat(i).chunk(2).value();return _.cat(e,_.map(j,function(d){var e=a.suggestTableFor(b.rounds,g,d[0],d[1]);return g=_.without(g,e),c.create(e,d[0],d[1])}))},[]).value()},suggestFirstRound:function(a,b){return f.suggestFirstSingleRound(a,b)},suggestNextRound:function(a,b){return f.suggestNextSingleRound(a,b)},suggestRound:function(a,b){return 0===e.bracketNbRounds(a,b)?f.suggestFirstRound(a,b):f.suggestNextRound(a,b)}};return f}]).factory("srPairing",["basePairing","players","rounds","game",function(a,b,c,d){var e={sortPlayers:function(a){var b;return _.chain(a).groupBy(function(a){return a.points.tournament}).apply(function(a){return b=a,a}).keys().sortBy(function(a){return parseFloat(a)}).map(function(a){return _.shuffle(b[a])}).flatten().reverse().value()},sortAvailablePlayersFor:function(a,b){var c;return _.chain(a).groupBy(_.partial(_.getPath,_,"points.tournament")).apply(function(a){return c=a,a}).keys().sortBy(function(a){return"undefined"===a?-1:parseFloat(a)}).map(function(a){var d=_.filter(c[a],function(a){return a.city!==b.city}),e=_.filter(c[a],function(a){return a.city===b.city});return _.cat(e,d)}).flatten().reverse().mapWith(_.partial(_.getPath,_,"name")).value()},suggestOpponentFor:function(a,b){var c=_.difference(b,a);return 0===c.length?b[0]:c[0]},findNextPairing:function(f,g,h){var i=_.first(g);g=_.rest(g);var j=c.opponentsForPlayer(f,i.name),k=e.sortAvailablePlayersFor(g,i),l=e.suggestOpponentFor(j,k),m=b.player(g,l);g=_.without(g,m);var n=a.suggestTableFor(f,h,i.name,m.name);return h=_.without(h,n),[d.create(n,i.name,m.name),g,h]},suggestNextSingleRound:function(b,c){var d=a.tableRangeForGroup(b.players,c),f=e.sortPlayers(b.players[c]);return 1===(1&f.length)&&f.push({name:"_phantom_"}),_.chain(b.players[c].length/2).range().map(function(){var a=e.findNextPairing(b.rounds,f,d);return f=a[1],d=a[2],a[0]}).sortBy(_.property("table")).value()},suggestNextRound:function(a,b){return e.suggestNextSingleRound(a,b)}};return e}]).factory("pairing",["bracketPairing","srPairing",function(a,b){var c={suggestRound:function(c,d,e){return _.exists(e)?a.suggestRound(c,d,e):b.suggestRound(c,d)}};return c}]),angular.module("srApp.services").factory("player",["rounds","lists",function(a,b){return{is:function(a,b){return a.name===b},rank:function(a,b){var c;try{c=b(a.points.tournament,a.points.sos,a.points.control,a.points.army)}catch(d){return"Error : "+d.message}return c},create:function(a,b,c,d){return{name:a,faction:b,city:c,team:d,lists:[],lists_played:[],points:{tournament:0,sos:0,control:0,army:0}}},updateListsPlayed:function(b,c){return _.chain(b).clone().apply(function(b){return b.lists_played=a.listsForPlayer(c,b.name),b}).value()},allListsHaveBeenPlayed:function(a){return 0===_.chain(a.lists).apply(b.casters).difference(a.lists_played).value().length},updatePoints:function(b,c,d,e){return _.chain(b).clone().apply(function(b){return b.points=a.pointsForPlayer(c,b.name,d,e),b}).value()}}}]).factory("players",["player","factions","round","rounds","ranking","lists",function(a,b,c,d,e,f){var g={add:function(a,b,c){return a[c]=_.cat(a[c],b),a},drop:function(b,c){return _.chain(b).mapWith(_.reject,_.partial(a.is,_,c.name)).reject(_.isEmpty).apply(function(a){return 0===a.length?[[]]:a}).value()},player:function(b,c){return _.chain(b).flatten().find(_.partial(a.is,_,c)).value()},names:function(a){return _.chain(a).flatten().mapWith(_.getPath,"name").sortBy(_.identity).value()},factions:function(a,b){return _.chain(a).flatten().mapWith(_.getPath,"faction").cat(_.keys(b)).uniq().without(void 0).sortBy(_.identity).value()},forFaction:function(a,b){return _.chain(a).flatten().filter(function(a){return _.getPath(a,"faction")===b
}).value()},casters:function(a){return _.chain(a).flatten().mapWith(_.getPath,"lists").flatten().without(void 0,null).map(function(a){return _.exists(a.caster)?{faction:a.faction||"",name:a.caster||""}:void 0}).without(void 0,null).uniq(!1,_.partial(_.getPath,_,"name")).apply(function(a){return a.sort(function(a,b){var c=a.faction.localeCompare(b.faction);return 0!==c?c:a.name.localeCompare(b.name)})}).value()},forCaster:function(a,b){return _.chain(a).flatten().filter(function(a){return _.chain(a).getPath("lists").apply(f.containsCaster,b).value()}).value()},cities:function(a){return _.chain(a).flatten().mapWith(_.getPath,"city").uniq().without(void 0).sortBy(_.identity).value()},updateListsPlayed:function(b,c){return _.chain(b).map(function(b){return _.mapWith(b,a.updateListsPlayed,c)}).value()},updatePoints:function(b,c,e,f){var h=_.chain(b).map(function(b,d){return _.mapWith(b,a.updatePoints,c,e[d],f[d])}).value();return _.chain(h).map(function(a){return _.map(a,function(a){var b=d.opponentsForPlayer(c,a.name);return a.points.sos=g.sosFromPlayers(h,b),a})}).value()},sortGroup:function(b,c,d){var f;if(d)f=function(a){return a.points.bracket};else{var g=e.buildPlayerCritFunction(c.ranking.player,c.rounds.length,b.length);if(!_.isFunction(g))return b;f=_.partial(a.rank,_,g)}var h,i=0;return _.chain(b).groupBy(f).apply(function(a){return h=a,a}).keys().sortBy(function(a){return-parseFloat(a)}).reduce(function(a,b){return a.push({rank:i+1,players:h[b]}),i+=h[b].length,a},[]).value()},sort:function(a,b,c){return _.map(a,function(a,d){return g.sortGroup(a,b,c[d])})},sosFromPlayers:function(a,b){return _.chain(b).map(_.partial(g.player,a)).without(void 0).reduce(function(a,b){return a+_.getPath(b,"points.tournament")},0).value()},areAllPaired:function(a,b){return 0===_.chain(a).apply(g.names).difference(c.pairedPlayers(b)).value().length},indexRangeForGroup:function(a,b){var c=_.chain(a).slice(0,b).flatten().value().length,d=c+a[b].length;return[c,d]},chunkGroups:function(a,b){return _.chain(a).flatten().chunkAll(b).value()},splitNewGroup:function(a,b){var c=_.map(b,_.partial(g.player,a));return _.chain(a).mapWith(_.difference,c).cat([c]).reject(_.isEmpty).value()},groupForPlayer:function(a,b){return _.chain(a).map(function(a){return _.findWhere(a,{name:b})}).reduce(function(a,b,c){return _.exists(a)?a:_.exists(b)?c:null},null).value()},movePlayerGroupFront:function(a,b){var c=g.groupForPlayer(a,b);if(0===c)return a;var d=g.player(a,b),e=a.slice();return e[c]=_.difference(a[c],[d]),e[c-1]=_.cat(a[c-1],d),_.reject(e,_.isEmpty)},movePlayerGroupBack:function(a,b){var c=g.groupForPlayer(a,b);if(a.length===c+1)return a;var d=g.player(a,b),e=a.slice();return e[c]=_.difference(a[c],[d]),e[c+1]=_.cat(a[c+1],d),_.reject(e,_.isEmpty)},moveGroupFront:function(a,b){if(0===b)return a;var c=a.slice();return c.splice(b,1),c.splice(b-1,0,a[b]),c},moveGroupBack:function(a,b){if(a.length===b+1)return a;var c=a.slice();return c.splice(b,1),c.splice(b+1,0,a[b]),c},size:function(a){return _.flatten(a).length},nbGroups:function(a){return a.length},groupSizeIsEven:function(a){return 0===(1&a.length)}};return g}]),angular.module("srApp.services").factory("ranking",[function(){var a={srPlayerCrit:function(){return"((tp*n_players*n_players+sos)*5*n_rounds+cp)*100*n_rounds+ap"},srTeamCrit:function(){return"(((ttp*team_size*n_rounds+tp)*n_teams*n_teams+sos)*5*n_rounds+cp)*100*n_rounds+ap"},buildPlayerCritFunction:function(a,b,c){var d,e;try{d=new Function("n_rounds","n_players","tp","sos","cp","ap","return "+a+";"),e=_.partial(d,b,c)}catch(f){return"Error : "+f.message}return e}};return a}]),angular.module("srApp.services").factory("round",["game",function(a){var b={gameForPlayer:function(b,c){return _.isArray(b)&&0!==b.length?_.chain(b).map(_.partial(a.forPlayer,_,c)).without(void 0).first().value():void 0},gamesForGroup:function(a,b,c){var d=Math.ceil(_.chain(b).slice(0,c).flatten().value().length/2),e=Math.ceil(d+b[c].length/2);return _.chain(a).slice(d,e).value()},pairedPlayers:function(a){return _.chain(a).flatten().map(function(a){return[a.p1.name,a.p2.name]}).flatten().uniq().without(null,void 0).value()},isPlayerPaired:function(a,c){return 0<=_.chain(a).apply(b.pairedPlayers).indexOf(c.name).value()},updatePlayer:function(a,b,c){var d=a[b][c].name;return _.chain(a).map(function(a,e){if(e===b&&"p1"===c)return a;if(a.p1.name===d){var f=_.snapshot(a);return f.p1.name=null,f}return a}).map(function(a,e){if(e===b&&"p2"===c)return a;if(a.p2.name===d){var f=_.snapshot(a);return f.p2.name=null,f}return a}).value()},winners:function(b){return _.map(b,a.winner)},losers:function(b){return _.map(b,a.loser)}};return b}]).factory("rounds",["round","game","games",function(a,b,c){var d={createNextRound:function(a){var c=1;return _.map(a,function(a){return _.chain(a.length/2).range().map(function(){return b.create(c++)}).value()})},registerNextRound:function(a,b){return _.cat(a,[_.flatten(b)])},drop:function(a,b){var c=a.slice();return c.splice(b,1),c},pointsForPlayer:function(b,d,e,f){return _.chain(b).mapWith(a.gameForPlayer,d).map(function(a){return _.exists(a)?a:{p1:{name:d,tournament:0,control:0,army:0}}}).apply(c.pointsForPlayer,d,e,f).value()},gamesForPlayer:function(b,c){return _.chain(b).mapWith(a.gameForPlayer,c).without(void 0).value()},opponentsForPlayer:function(b,d){return _.chain(b).mapWith(a.gameForPlayer,d).without(void 0).apply(c.opponentsForPlayer,d).value()},pairAlreadyExists:function(a,b){return _.exists(_.getPath(b,"p1.name"))&&_.exists(_.getPath(b,"p2.name"))?_.chain(a).apply(d.opponentsForPlayer,b.p1.name).indexOf(b.p2.name).value()>=0:!1},listsForPlayer:function(b,d){return _.chain(b).mapWith(a.gameForPlayer,d).apply(c.listsForPlayer,d).value()},tablesForPlayer:function(b,d){return _.chain(b).mapWith(a.gameForPlayer,d).apply(c.tablesForPlayer,d).value()}};return d}]),angular.module("srApp.services").factory("state",["$window","jsonStringifier","player","players","game","list","lists","ranking",function(a,b,c,d,e,f,g,h){var i="sdApp.state",j={isEmpty:function(a){return 0===_.flatten(a.players).length&&0===_.flatten(a.rounds).length},init:function(){var b=a.localStorage.getItem(i);if(_.exists(b))try{return b=JSON.parse(b),j.create(b)}catch(c){}return j.create()},test:function(a){var b=_.clone(a),h=["Faction1","Faction2","Faction3","Faction4"],i=["City1","City2","City3","City4"],k=["Team1","Team2","Team3","Team4"];return b.players=[[],[]],_.range(8).map(function(a){var d=_.chain(h).shuffle().first().value();b.players[a>>2].push(c.create("Player"+(a+1),d,_.chain(i).shuffle().first().value(),_.chain(k).shuffle().first().value())),b.players[a>>2][a%4].lists.push(f.create(d,"Caster1"),f.create(d,"Caster2"))}),_.range(2).map(function(a){b.rounds.push([]);var c=1;_.each(b.players,function(f){var h=_.shuffle(d.names(f));_.range(h.length/2).map(function(){var f=_.first(h);h=_.rest(h);var i=_.first(h);h=_.rest(h);var j=e.create(c++,f,i);j.p1.list=_.chain(b.players).apply(d.player,f).getPath("lists").apply(g.casters).shuffle().first().value(),j.p2.list=_.chain(b.players).apply(d.player,i).getPath("lists").apply(g.casters).shuffle().first().value();var k=_.shuffle(["p1","p2"]);j[k[0]].tournament=1,j[k[1]].tournament=0,j.p1.control=5*Math.random()>>0,j.p2.control=5*Math.random()>>0,j.p1.army=50*Math.random()>>0,j.p2.army=50*Math.random()>>0,b.rounds[a].push(j)})})}),b.bracket=[void 0,1],b.players=j.updatePlayersPoints(b),b},create:function(a){var b=_.clone(a||{}),c=_.defaults(b,{bracket:[],players:[[]],rounds:[],ranking:{player:h.srPlayerCrit(),team:h.srTeamCrit()}});return c.players=j.updatePlayersPoints(c),j.store(c),c},store:function(c){a.localStorage.setItem(i,b.stringify(c))},hasPlayers:function(a){return 0!==_.flatten(a.players).length},hasPlayerGroups:function(a){return a.players.length>1},isTeamTournament:function(a){return 0!==_.flatten(a.teams).length},clearBracket:function(a){return _.repeat(a.players.length,void 0)},setBracketLength:function(a,b){return a.bracket.length>=b?_.clone(a.bracket):_.cat(a.bracket,_.repeat(b-a.bracket.length,void 0))},setBracket:function(a,b){var c=j.setBracketLength(a,b+1);return c[b]=_.exists(c[b])?c[b]:a.rounds.length,c},resetBracket:function(a,b){var c=j.setBracketLength(a,b+1);return c[b]=void 0,c},canBeBracketTournament:function(a,b){var c=a.players[b].length;if(0===c)return!1;for(;0===(1&c);)c>>=1;return 1===c},isBracketTournament:function(a,b,c){{var d=_.exists(c)?c:a.rounds.length;j.setBracketLength(a,b+1)}return _.exists(a.bracket[b])&&d>=a.bracket[b]},bracketNbRounds:function(a,b){var c=j.setBracketLength(a,b+1);return _.exists(c[b])?a.rounds.length-c[b]:0},bracketRoundOf:function(a,b,c){if(!_.exists(a.bracket[b]))return"Not in bracket";var d=_.exists(c)?c:a.rounds.length,e=a.players[b].length>>d-a.bracket[b]+1;switch(e){case 0:return"Ended";case 1:return"Final";case 2:return"Semi-finals";case 4:return"Quarter-finals";default:return"Round of "+e}},updatePlayersPoints:function(a){var b=j.setBracketLength(a,a.players.length),c=_.map(a.players,function(a){return a.length/2});return d.updatePoints(a.players,a.rounds,b,c)},sortPlayers:function(a){var b=_.map(a.players,function(b,c){return j.isBracketTournament(a,c)});return d.sort(a.players,a,b)},rankingTables:function(a){return _.chain(a).apply(j.sortPlayers).map(function(a){return _.chain(a).map(function(a){return _.map(a.players,function(b){return[a.rank,b.name,b.city,b.faction,b.points.tournament,b.points.sos,b.points.control,b.points.army]})}).flatten().chunk(8).value()}).map(function(a){return _.cat([["Rank","Name","City","Faction","TP","SoS","CP","AP"]],a)}).spy("tables").value()}};return j}]),angular.module("srApp.services").factory("stats",["statsFactionSelector","statsPlayerSelector","statsCasterSelector","statsGroupByTotal","statsGroupByOppFaction","statsGroupByOppCaster","statsPointsEntry","statsCastersEntry","statsOppCastersEntry","statsTiersEntry","statsReferencesEntry",function(a,b,c,d,e,f,g,h,i,j,k){var l={faction:a,player:b,caster:c},m={total:d,opp_faction:e,opp_caster:f},n={get:function(a,b,c,d,e){if(e[b]=e[b]||{},e[b][c]=e[b][c]||{},!_.exists(e[b][c][d])){var f=l[b].select(a,c);f=m[d].group(a,f),e[b][c][d]=_.map(f,function(b){return[b[0],{points:g.count(a,b[1]),casters:h.count(a,b[1]),opp_casters:i.count(a,b[1]),tiers:j.count(a,b[1]),references:k.count(a,b[1])}]})}return e[b][c][d]}};return n}]),angular.module("srApp.services").factory("statsPointsEntry",["games",function(a){var b={count:function(b,c){return{colors:["#4AE34D","#E3341D"],values:_.chain(c).mapWith(function(b){return[a.pointsForPlayer(b[1],b[0]),a.pointsAgainstPlayer(b[1],b[0]),b[1].length]}).reduce(function(a,b){return[{tournament:a[0].tournament+b[0].tournament,control:a[0].control+b[0].control,army:a[0].army+b[0].army},{tournament:a[1].tournament+b[1].tournament,control:a[1].control+b[1].control,army:a[1].army+b[1].army},b[2]+a[2]]},[{tournament:0,control:0,army:0},{tournament:0,control:0,army:0},0]).apply(function(a){var b=0===a[2]?1:a[2];return{"Win/Loss":[a[0].tournament,a[1].tournament],Control:[Math.round(a[0].control/b*100)/100,Math.round(a[1].control/b*100)/100],Army:[Math.round(a[0].army/b*100)/100,Math.round(a[1].army/b*100)/100]}}).value()}}};return b}]).factory("statsCastersEntry",["factions","game","players",function(a,b,c){var d={count:function(d,e){return _.chain(e).map(function(a){return _.map(a[1],function(c){return[a[0],b.listForPlayer(c,a[0])]})}).flatten(!0).filter(function(a){return _.exists(a[0])&&_.exists(a[1])}).groupBy(function(a){return _.getPath(c.player(d.players,a[0]),"faction")}).map(function(b,c){var d=_.map(b,function(a){return a[1]});return[c,_.countBy(d,_.identity),a.hueFor(c)]}).value()}};return d}]).factory("statsOppCastersEntry",["factions","game","players",function(a,b,c){var d={count:function(d,e){return _.chain(e).map(function(a){return _.map(a[1],function(c){var d=b.opponentForPlayer(c,a[0]);return[d,b.listForPlayer(c,d)]})}).flatten(!0).filter(function(a){return _.exists(a[0])&&_.exists(a[1])}).groupBy(function(a){return _.getPath(c.player(d.players,a[0]),"faction")}).map(function(b,c){var d=_.map(b,function(a){return a[1]});return[c,_.countBy(d,_.identity),a.hueFor(c)]}).value()}};return d}]).factory("statsTiersEntry",["list","lists","players","game",function(a,b,c,d){var e={count:function(a,e){return _.chain(e).map(function(b){return[c.player(a.players,b[0]),_.chain(b[1]).mapWith(d.listForPlayer,b[0]).without(void 0,null).value()]}).filter(function(a){return _.exists(a[0])}).map(function(a){return _.map(a[1],function(c){return b.themeForCaster(a[0].lists,c)||"None"})}).flatten().without(null,void 0).countBy(_.identity).value()}};return e}]).factory("statsReferencesEntry",["list","lists","players","game",function(a,b,c,d){var e={count:function(e,f){return _.chain(f).map(function(a){return[c.player(e.players,a[0]),_.chain(a[1]).mapWith(d.listForPlayer,a[0]).without(void 0,null).uniq().value()]}).map(function(a){return _.map(a[1],function(c){return b.listForCaster(a[0].lists,c)})}).flatten().without(void 0,null).mapWith(a.references).mapWith(_.rest).flatten().countBy(_.identity).value()}};return e}]),angular.module("srApp.services").factory("statsGroupByTotal",[function(){var a={group:function(a,b){return[["Total",b]]}};return a}]).factory("statsGroupByOppFaction",["game","players",function(a,b){var c={group:function(c,d){return _.chain(d).map(function(d){return[d[0],_.groupBy(d[1],function(e){var f=a.opponentForPlayer(e,d[0]),g=b.player(c.players,f);return _.getPath(g,"faction")||"NULL"})]}).reduce(function(a,b){return _.each(b[1],function(c,d){if("NULL"!==d){var e=s.capitalize(d);a[e]=a[e]||[],a[e].push([b[0],c])}}),a},{}).map(function(a,b){return[b,a]}).sortBy(_.first).value()}};return c}]).factory("statsGroupByOppCaster",["game","players",function(a){var b={group:function(b,c){return _.chain(c).map(function(b){return[b[0],_.groupBy(b[1],function(c){var d=a.opponentForPlayer(c,b[0]),e=a.player(c,d);return _.getPath(e,"list")||"NULL"})]}).reduce(function(a,b){return _.each(b[1],function(c,d){if("NULL"!==d){var e=s.capitalize(d);a[e]=a[e]||[],a[e].push([b[0],c])}}),a},{}).map(function(a,b){return[b,a]}).sortBy(_.first).value()}};return b}]),angular.module("srApp.services").factory("statsFactionSelector",["players","rounds",function(a,b){var c={select:function(c,d){var e=a.forFaction(c.players,d);return _.chain(e).mapWith(function(a){return[a.name,b.gamesForPlayer(c.rounds,a.name)]}).value()}};return c}]).factory("statsPlayerSelector",["players","rounds",function(a,b){var c={select:function(a,c){return[[c,b.gamesForPlayer(a.rounds,c)]]}};return c}]).factory("statsCasterSelector",["players","rounds","games",function(a,b,c){var d={select:function(d,e){var f=a.forCaster(d.players,e);return _.chain(f).map(function(a){return[a.name,b.gamesForPlayer(d.rounds,a.name)]}).map(function(a){return[a[0],c.forCaster(a[1],a[0],e)]}).filter(function(a){return!_.isEmpty(a[1])}).value()}};return d}]),angular.module("srApp.services").factory("t3Parser",["player",function(a){function b(a,b){var c=10===a.length;return c||b.error.push("line "+b.nline+" invalid fields number ("+a.length+" expected 10)"),c}function c(a,b){var c=s.trim(a[3]).length>0;return c||b.error.push("line "+b.nline+" empty player name"),c}function d(a,b){var c=0>_.indexOf(b.names,s.trim(a[3]));return c?b.names.push(s.trim(a[3])):b.error.push("line "+b.nline+' player name "'+s.trim(a[3])+'" already exists'),c}var e=[b,c,d];return{parse:function(b,c){var d=_.reduce(c,function(a,b){return a[b.t3]=b.name,a},{}),f={error:[],names:[]},g=_.chain(b).apply(s.lines).rest().filter(_.complement(s.isBlank)).mapWith(s.words,";").filter(function(a,b){f.nline=b+2;var c=_.map(e,function(b){return b(a,f)});return _.all(c)}).map(function(a){var b={name:s.trim(a[3]),city:a[5]};return _.each(d,function(c,d){s.include(a[4],d)&&(b.faction=c)}),b}).map(function(b){return a.create(b.name,b.faction,b.city)}).value();return[g,f.error]}}}]),angular.module("srApp.services").factory("team",[function(){return{is:_.rcurry2(function(a,b){return a.name===b}),rank:function(a,b){var c=b(a.points.team_tournament,a.points.tournament,a.points.sos,a.points.control,a.points.army);return c},create:function(a,b){return{name:a,city:b,points:{team_tournament:0,tournament:0,sos:0,control:0,army:0}}}}}]).factory("teams",["team","players","factions",function(a,b,c){var d={};c.baseFactions().then(function(a){d=a});var e={add:function(a,b,c){return a[c]=_.cat(a[c],b),a},drop:function(b,c){return _.map(b,function(b){return _.reject(b,_.unary(a.is(c.name)))})},team:function(b,c){return _.chain(b).flatten().find(_.unary(a.is(c))).value()},names:function(a){return _.chain(a).flatten().mapWith(_.getPath,"name").value()},cities:function(a){return _.chain(a).flatten().mapWith(_.getPath,"city").uniq().without(void 0).value()},factions:function(a){return _.chain(a).flatten().mapWith(_.getPath,"faction").cat(_.keys(d)).uniq().without(void 0).value()},sortGroup:function(c,d,e){if(_.exists(e.bracket[d]))return _.sortBy(c.slice(),function(a){return-a.points.bracket});var f=new Function("ttp","tp","sos","cp","ap","team_size","n_teams","n_players","n_rounds","return "+e.ranking.team+";"),g=_.chain(e.teams).flatten().map(function(a){return b.inTeam(e.players,a.name).length}).max().value(),h=_.flatten(e.teams).length,i=_.flatten(e.players).length,j=_.partial(f,_,_,_,_,_,g,h,i,e.rounds.length);return _.sortBy(c.slice(),function(b){return-a.rank(b,j)})},sort:function(a,b){return _.map(a,function(a,c){return e.sortGroup(a,c,b)})},sosFrom:function(a,b){return _.chain(b).map(_.partial(e.team,a)).reduce(function(a,b){return a+_.getPath(b,"points.team_tournament")},0).value()},teamSize:function(a,c){return _.chain(a).flatten().map(function(a){return b.inTeam(c,a.name).length}).max().value()},chunk:function(a,b){return _.chain(a).flatten().chunkAll(b).value()}};return e}]);